<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>The Ai STudio - V6 Ultra</title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600;800&family=Space+Grotesk:wght@300;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        :root {
            --bg-dark: #000000;
            --surface: #0f0f12;
            --glass: rgba(20, 20, 23, 0.6);
            --glass-border: rgba(255, 255, 255, 0.08);
            --primary: #ffe135; /* Default Banana */
            --sora-cyan: #00f2ff;
            --danger: #ff2a2a;
            --text-main: #ffffff;
            --text-muted: #888888;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; font-family: 'Outfit', sans-serif; -webkit-tap-highlight-color: transparent; }
        body { background-color: var(--bg-dark); color: var(--text-main); height: 100vh; width: 100vw; overflow: hidden; }

        /* --- SCROLLBAR --- */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #333; border-radius: 3px; }

        /* --- BANNERS --- */
        .sys-banner {
            position: fixed; top: 0; left: 0; width: 100%; 
            color: white; text-align: center; padding: 8px; font-weight: 800; letter-spacing: 1px;
            z-index: 99999; display: none; font-family: 'Space Grotesk'; text-transform: uppercase; font-size: 0.8rem;
        }
        #offline-banner { background: repeating-linear-gradient(45deg, #ff2a2a, #ff2a2a 10px, #cc0000 10px, #cc0000 20px); }
        #traffic-banner { background: repeating-linear-gradient(45deg, #ff9100, #ff9100 10px, #cc7400 10px, #cc7400 20px); color: black; }

        /* --- LAYOUT & SCREENS --- */
        .screen {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            display: none; flex-direction: column; overflow: hidden;
            background: var(--bg-dark);
        }
        .screen.active { display: flex; animation: fadeIn 0.4s ease; }
        .centered { align-items: center; justify-content: center; }

        /* --- NAVIGATION --- */
        .nav-dock {
            position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%);
            background: rgba(10, 10, 10, 0.8); backdrop-filter: blur(20px);
            border: 1px solid var(--glass-border); border-radius: 50px;
            padding: 10px 30px; display: flex; gap: 30px; align-items: center;
            z-index: 5000; box-shadow: 0 10px 40px rgba(0,0,0,0.5);
        }
        .nav-item { color: #666; font-size: 1.2rem; cursor: pointer; transition: 0.3s; position: relative; }
        .nav-item:hover { color: white; }
        .nav-item.active { color: var(--primary); }
        .nav-item.active::after {
            content: ''; position: absolute; bottom: -8px; left: 50%; transform: translateX(-50%);
            width: 4px; height: 4px; background: var(--primary); border-radius: 50%;
        }

        /* --- FEED (SORA STYLE) --- */
        .feed-container {
            flex: 1; overflow-y: scroll; scroll-snap-type: y mandatory; height: 100%; position: relative;
        }
        .post-item {
            width: 100%; height: 100vh; scroll-snap-align: start; position: relative;
            background: #111; overflow: hidden; display: flex; align-items: center; justify-content: center;
        }
        .post-media-bg {
            width: 100%; height: 100%; object-fit: cover; opacity: 0.3; position: absolute; filter: blur(20px); transform: scale(1.1);
        }
        .post-media-main {
            max-width: 100%; max-height: 100%; width: auto; height: auto; 
            object-fit: contain; z-index: 2; box-shadow: 0 0 50px rgba(0,0,0,0.5);
        }
        .post-overlay {
            position: absolute; bottom: 0; left: 0; width: 100%; 
            background: linear-gradient(to top, rgba(0,0,0,0.9), transparent);
            padding: 100px 20px 40px 20px; z-index: 10; pointer-events: none;
        }
        .post-content { pointer-events: auto; max-width: 800px; margin: 0 auto; }
        .post-user { display: flex; align-items: center; gap: 10px; margin-bottom: 10px; }
        .post-avatar { width: 35px; height: 35px; border-radius: 50%; border: 1px solid white; }
        .post-handle { font-weight: 700; font-size: 1rem; }
        .post-title { font-size: 1.2rem; margin-bottom: 5px; font-weight: 300; }
        .post-prompt { font-size: 0.85rem; color: #ccc; margin-bottom: 15px; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; opacity: 0.8; }
        .post-actions { display: flex; gap: 20px; align-items: center; margin-top: 15px; }
        .action-pill { 
            background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.1); 
            padding: 8px 16px; border-radius: 30px; font-size: 0.9rem; cursor: pointer; 
            display: flex; align-items: center; gap: 8px; transition: 0.2s; backdrop-filter: blur(5px);
        }
        .action-pill:hover { background: rgba(255,255,255,0.2); }
        .liked { color: #ff2a2a; border-color: rgba(255, 42, 42, 0.3); background: rgba(255, 42, 42, 0.1); }

        /* --- CREATE STUDIO --- */
        .studio-layout {
            max-width: 900px; margin: 0 auto; width: 100%; padding: 80px 20px 100px 20px; overflow-y: auto; height: 100%;
        }
        .model-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 30px; }
        .model-select {
            background: var(--surface); border: 1px solid var(--glass-border); padding: 20px; border-radius: 16px;
            cursor: pointer; transition: 0.3s; text-align: center; position: relative; overflow: hidden;
        }
        .model-select.active { border-color: var(--primary); background: rgba(255,255,255,0.03); }
        .model-select i { font-size: 1.5rem; margin-bottom: 10px; color: #555; }
        .model-select.active i { color: var(--primary); }

        .input-box {
            background: var(--surface); border: 1px solid var(--glass-border); border-radius: 20px; padding: 20px;
            position: relative; margin-bottom: 20px;
        }
        .magic-textarea {
            width: 100%; background: transparent; border: none; color: white; font-size: 1.1rem; 
            min-height: 120px; resize: none; outline: none; line-height: 1.5;
        }
        .generate-btn {
            width: 100%; background: var(--primary); color: black; font-weight: 800; font-family: 'Space Grotesk';
            text-transform: uppercase; padding: 18px; border-radius: 12px; border: none; font-size: 1rem;
            cursor: pointer; transition: 0.3s; letter-spacing: 1px;
        }
        .generate-btn:hover { transform: scale(1.02); box-shadow: 0 0 30px var(--primary); }
        .generate-btn:disabled { background: #333; color: #666; cursor: not-allowed; box-shadow: none; transform: none; }

        /* --- PROFILE --- */
        .profile-header { text-align: center; margin-bottom: 40px; padding-top: 50px; }
        .p-avatar { width: 100px; height: 100px; border-radius: 50%; border: 3px solid var(--primary); object-fit: cover; margin-bottom: 15px; }
        .p-handle { font-family: 'Space Grotesk'; font-size: 1.5rem; margin-bottom: 5px; }
        .p-stats { color: #888; font-size: 0.9rem; display: flex; justify-content: center; gap: 20px; }
        .tabs { display: flex; justify-content: center; gap: 20px; margin-bottom: 30px; border-bottom: 1px solid #222; }
        .tab-btn { background: none; border: none; color: #666; padding: 10px 20px; cursor: pointer; border-bottom: 2px solid transparent; }
        .tab-btn.active { color: white; border-color: var(--primary); }
        
        .grid-gallery { display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 10px; padding-bottom: 100px; }
        .grid-item { aspect-ratio: 9/16; background: #111; border-radius: 10px; overflow: hidden; position: relative; cursor: pointer; }
        .grid-item img, .grid-item video { width: 100%; height: 100%; object-fit: cover; }
        .status-badge { position: absolute; top: 5px; right: 5px; font-size: 0.7rem; padding: 2px 6px; border-radius: 4px; background: rgba(0,0,0,0.7); color: white; }

        /* --- AUTH & ONBOARDING --- */
        #screen-login, #screen-onboarding { z-index: 6000; background: rgba(0,0,0,0.8); backdrop-filter: blur(30px); }
        .auth-card { width: 90%; max-width: 380px; text-align: center; }
        .auth-input { 
            width: 100%; padding: 15px; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); 
            border-radius: 10px; color: white; margin-bottom: 10px; outline: none; transition: 0.3s;
        }
        .auth-input:focus { border-color: var(--primary); background: rgba(255,255,255,0.1); }
        
        /* --- ADMIN PANEL --- */
        #screen-admin { z-index: 7000; background: #050505; overflow-y: auto; padding: 30px; }
        .admin-row { 
            background: #111; border: 1px solid #222; padding: 15px; margin-bottom: 15px; border-radius: 8px; 
            display: flex; flex-direction: column; gap: 10px;
        }
        .admin-meta { display: flex; justify-content: space-between; font-size: 0.85rem; color: #666; font-family: monospace; }
        .admin-status-select { background: #000; color: white; border: 1px solid #333; padding: 5px; border-radius: 4px; }
        .status-copyright { color: #ff9100; }

        /* --- COMMENTS MODAL --- */
        .comments-modal {
            position: absolute; bottom: 0; left: 0; width: 100%; height: 70%; background: #0f0f12;
            border-top-left-radius: 20px; border-top-right-radius: 20px; transform: translateY(100%); transition: 0.3s; z-index: 2000;
            display: flex; flex-direction: column;
        }
        .comments-modal.active { transform: translateY(0); }
        .cm-header { padding: 15px; border-bottom: 1px solid #222; text-align: center; font-weight: bold; position: relative; }
        .cm-close { position: absolute; right: 15px; top: 15px; cursor: pointer; }
        .cm-list { flex: 1; overflow-y: auto; padding: 15px; }
        .comment-item { margin-bottom: 15px; font-size: 0.9rem; }
        .comment-handle { color: #888; font-size: 0.8rem; margin-right: 5px; font-weight: bold; }
        .cm-input-area { padding: 15px; border-top: 1px solid #222; display: flex; gap: 10px; }

        /* UTIL */
        .hidden { display: none !important; }
        .loader { width: 30px; height: 30px; border: 3px solid #333; border-top-color: var(--primary); border-radius: 50%; animation: spin 1s infinite; }
        @keyframes spin { 100% { transform: rotate(360deg); } }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    </style>
</head>
<body>

    <div id="offline-banner" class="sys-banner">
        <i class="fa-solid fa-triangle-exclamation"></i> SYSTEMS OFFLINE: MAINTENANCE
    </div>
    <div id="traffic-banner" class="sys-banner">
        <i class="fa-solid fa-fire"></i> HIGH TRAFFIC: QUEUE IS FULL. TRY AGAIN SOON.
    </div>

    <div id="screen-loading" class="screen active centered" style="z-index: 9999;">
        <div class="loader"></div>
    </div>

    <div id="screen-login" class="screen centered">
        <div class="auth-card">
            <h1 style="font-family: 'Space Grotesk'; font-size: 2.5rem; margin-bottom: 10px;">The Ai <span style="color:var(--primary)">STudio</span></h1>
            <p style="color:#888; margin-bottom: 30px;">Professional Generation Suite</p>
            <button id="btn-login-google" class="generate-btn" style="background: white; color: black; margin-bottom: 10px;">
                <i class="fa-brands fa-google"></i> Continue with Google
            </button>
            <p id="login-error" style="color: var(--danger); font-size: 0.8rem; margin-top: 10px;"></p>
        </div>
    </div>

    <div id="screen-onboarding" class="screen centered">
        <div class="auth-card">
            <h2>Claim Your Handle</h2>
            <p style="color:#666; margin-bottom: 20px; font-size: 0.9rem;">Choose a unique username for the platform.</p>
            <div style="position: relative;">
                <span style="position: absolute; left: 15px; top: 15px; color: #666;">@</span>
                <input type="text" id="inp-handle" class="auth-input" style="padding-left: 35px;" placeholder="username" maxlength="15">
            </div>
            <button id="btn-save-handle" class="generate-btn">START CREATING</button>
            <p id="handle-error" style="color: var(--danger); margin-top: 10px; font-size: 0.8rem;"></p>
        </div>
    </div>

    <div id="screen-app" class="screen">
        
        <div id="view-home" class="screen active" style="position: relative;">
            <div class="feed-container" id="feed-list">
                </div>
        </div>

        <div id="view-create" class="screen">
            <div class="studio-layout">
                <h2 style="font-family: 'Space Grotesk'; margin-bottom: 20px;">Create New</h2>
                
                <div class="model-grid">
                    <div class="model-select active" id="m-banana" onclick="selectModel('banana')">
                        <i class="fa-solid fa-image"></i>
                        <h3>Nano Banana</h3>
                        <div style="font-size:0.7rem; color:#666;">High Fidelity Image</div>
                    </div>
                    <div class="model-select" id="m-sora" onclick="selectModel('sora')">
                        <i class="fa-solid fa-video"></i>
                        <h3>Sora 2</h3>
                        <div style="font-size:0.7rem; color:#666;">Cinematic Video</div>
                    </div>
                </div>

                <div class="input-box">
                    <textarea id="inp-prompt" class="magic-textarea" placeholder="Describe your imagination in detail..."></textarea>
                    
                    <div style="display: flex; gap: 10px; margin-top: 15px; border-top: 1px solid rgba(255,255,255,0.1); padding-top: 15px;">
                        <label class="action-pill" style="cursor: pointer;">
                            <i class="fa-solid fa-paperclip"></i> Ref Image
                            <input type="file" id="inp-ref" hidden accept="image/*">
                        </label>
                        <div id="ref-indicator" style="font-size: 0.8rem; color: var(--primary); align-self: center;"></div>
                        
                        <div id="sora-opts" class="hidden" style="display:flex; gap:10px;">
                            <select id="inp-dur" style="background:#222; color:white; border:none; padding:5px; border-radius:5px;">
                                <option value="5">5s</option>
                                <option value="10" selected>10s</option>
                            </select>
                        </div>
                    </div>
                    
                    <div style="margin-top: 15px; display: flex; align-items: center; gap: 10px;">
                        <input type="checkbox" id="inp-public" checked>
                        <label for="inp-public" style="font-size: 0.9rem; color: #aaa;">Publish to Feed</label>
                    </div>
                    <input type="text" id="inp-title" class="auth-input" placeholder="Give it a title (optional)" style="margin-top: 10px; background: rgba(0,0,0,0.3);">
                </div>

                <div id="upload-progress" style="height: 4px; background: #333; width: 100%; border-radius: 2px; margin-bottom: 10px; display: none;">
                    <div id="upload-fill" style="height: 100%; background: var(--primary); width: 0%;"></div>
                </div>

                <button id="btn-generate" class="generate-btn" onclick="submitRequest()">GENERATE</button>
            </div>
        </div>

        <div id="view-profile" class="screen">
            <div class="studio-layout">
                <div class="profile-header">
                    <img id="p-avatar-img" class="p-avatar" src="">
                    <h2 id="p-handle-text" class="p-handle">@user</h2>
                    <div class="p-stats">
                        <span id="stat-posts">0 Posts</span>
                        <span style="cursor: pointer;" onclick="doLogout()">LOGOUT <i class="fa-solid fa-right-from-bracket"></i></span>
                    </div>
                </div>

                <div class="tabs">
                    <button class="tab-btn active" onclick="switchProfileTab('public')">PUBLIC</button>
                    <button class="tab-btn" onclick="switchProfileTab('private')">DRAFTS/PRIVATE</button>
                </div>

                <div id="profile-grid" class="grid-gallery"></div>
            </div>
        </div>

        <div class="nav-dock">
            <div class="nav-item active" onclick="navTo('home')"><i class="fa-solid fa-house"></i></div>
            <div class="nav-item" onclick="navTo('create')"><i class="fa-solid fa-plus"></i></div>
            <div class="nav-item" onclick="navTo('profile')"><i class="fa-solid fa-user"></i></div>
            <div class="nav-item hidden" id="nav-admin" onclick="toggleAdmin(true)" style="color: var(--danger);"><i class="fa-solid fa-terminal"></i></div>
        </div>

        <div id="comments-sheet" class="comments-modal">
            <div class="cm-header">
                Comments <span id="cm-count">(0)</span>
                <i class="fa-solid fa-xmark cm-close" onclick="closeComments()"></i>
            </div>
            <div id="cm-list" class="cm-list"></div>
            <div class="cm-input-area">
                <input type="text" id="cm-input" class="auth-input" style="margin:0;" placeholder="Add a comment...">
                <button onclick="postComment()" style="background:var(--primary); border:none; padding:0 15px; border-radius:10px; font-weight:bold;">POST</button>
            </div>
        </div>

    </div>

    <div id="screen-admin" class="screen">
        <h2 style="color: var(--danger); font-family: 'Space Grotesk'; margin-bottom: 20px;">ADMIN TERMINAL</h2>
        <div style="margin-bottom: 20px; display: flex; gap: 10px; flex-wrap: wrap;">
            <button onclick="toggleAdmin(false)" style="padding: 10px; background: #333; color: white; border: none; border-radius: 5px;">EXIT</button>
            <button onclick="toggleSys('offline')" id="btn-sys-offline" style="padding: 10px; background: #222; color: white; border: 1px solid #444; border-radius: 5px;">OFFLINE MODE</button>
            <button onclick="toggleSys('traffic')" id="btn-sys-traffic" style="padding: 10px; background: #222; color: white; border: 1px solid #444; border-radius: 5px;">FULL QUEUE MODE</button>
        </div>
        <div id="admin-feed"></div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-app.js";
        import { getAuth, signInWithPopup, GoogleAuthProvider, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-auth.js";
        import { getFirestore, collection, addDoc, query, where, onSnapshot, serverTimestamp, updateDoc, doc, deleteDoc, orderBy, limit, getDocs, setDoc, getDoc, arrayUnion, arrayRemove, runTransaction } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDQacpiI3oIqOUx8ciMfdlQgBtHZEVdcMo",
            authDomain: "anymousxe-aistudio.firebaseapp.com",
            projectId: "anymousxe-aistudio",
            storageBucket: "anymousxe-aistudio.firebasestorage.app",
            messagingSenderId: "518478280058",
            appId: "1:518478280058:web:422404fc54c21e5ea312c3",
            measurementId: "G-F9YHW3MWCW"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const provider = new GoogleAuthProvider();
        const ADMIN_EMAIL = "anymousxe.info@gmail.com";

        let currentUser = null;
        let userHandle = null;
        let currentModel = 'banana';
        let refImgData = null;
        let activePostId = null; // For comments
        
        let sysState = { offline: false, highTraffic: false };

        // --- AUTH ---
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                currentUser = user;
                // Check for handle
                const userDoc = await getDoc(doc(db, "users", user.uid));
                if (userDoc.exists()) {
                    userHandle = userDoc.data().handle;
                    initApp();
                } else {
                    document.getElementById('screen-loading').classList.remove('active');
                    document.getElementById('screen-onboarding').classList.add('active');
                }
            } else {
                document.getElementById('screen-loading').classList.remove('active');
                document.getElementById('screen-login').classList.add('active');
            }
        });

        document.getElementById('btn-login-google').onclick = () => signInWithPopup(auth, provider).catch(e => alert(e.message));
        window.doLogout = () => { signOut(auth); window.location.reload(); };

        document.getElementById('btn-save-handle').onclick = async () => {
            const h = document.getElementById('inp-handle').value.trim().toLowerCase().replace(/[^a-z0-9_]/g, '');
            if (h.length < 3) return document.getElementById('handle-error').innerText = "Too short.";
            
            // Check uniqueness
            const q = query(collection(db, "users"), where("handle", "==", h));
            const snap = await getDocs(q);
            if (!snap.empty) return document.getElementById('handle-error').innerText = "Taken.";

            await setDoc(doc(db, "users", currentUser.uid), {
                handle: h,
                email: currentUser.email,
                pfp: currentUser.photoURL,
                uid: currentUser.uid
            });
            userHandle = h;
            document.getElementById('screen-onboarding').classList.remove('active');
            initApp();
        };

        function initApp() {
            document.getElementById('screen-login').classList.remove('active');
            document.getElementById('screen-loading').classList.remove('active');
            document.getElementById('screen-app').classList.add('active');
            
            if (currentUser.email === ADMIN_EMAIL) {
                document.getElementById('nav-admin').classList.remove('hidden');
                initAdmin();
            }

            // Load Profile Data
            document.getElementById('p-avatar-img').src = currentUser.photoURL;
            document.getElementById('p-handle-text').innerText = "@" + userHandle;

            loadFeed();
            loadProfile('public');
            listenSys();
        }

        // --- NAVIGATION ---
        window.navTo = (view) => {
            document.querySelectorAll('.screen').forEach(s => {
                if(s.id.startsWith('view-')) s.classList.remove('active');
            });
            document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
            
            document.getElementById(`view-${view}`).classList.add('active');
            // Hacky nav active state logic
            const idx = ['home','create','profile'].indexOf(view);
            document.querySelectorAll('.nav-dock .nav-item')[idx].classList.add('active');

            if (view === 'profile') loadProfile('public');
        };

        window.selectModel = (m) => {
            currentModel = m;
            document.querySelectorAll('.model-select').forEach(e => e.classList.remove('active'));
            document.getElementById(`m-${m}`).classList.add('active');
            
            if(m === 'sora') {
                document.getElementById('sora-opts').classList.remove('hidden');
                document.documentElement.style.setProperty('--primary', '#00f2ff');
            } else {
                document.getElementById('sora-opts').classList.add('hidden');
                document.documentElement.style.setProperty('--primary', '#ffe135');
            }
        };

        // --- CREATION LOGIC ---
        document.getElementById('inp-ref').onchange = async (e) => {
            const file = e.target.files[0];
            if (!file) return;
            document.getElementById('upload-progress').style.display = 'block';
            document.getElementById('ref-indicator').innerText = "Uploading...";
            
            try {
                const gid = await uploadFileAsChunks(file, (p) => {
                    document.getElementById('upload-fill').style.width = p + '%';
                });
                refImgData = "group:" + gid;
                document.getElementById('ref-indicator').innerText = "Attached: " + file.name;
            } catch(e) {
                alert("Upload failed");
            }
        };

        window.submitRequest = async () => {
            if (sysState.offline) return alert("System Offline");
            if (sysState.highTraffic) return alert("Queue is full right now due to high traffic! Try again in 5 mins.");

            const prompt = document.getElementById('inp-prompt').value;
            if (!prompt) return alert("Write a prompt!");

            const btn = document.getElementById('btn-generate');
            btn.disabled = true;
            btn.innerText = "SENDING TO QUEUE...";

            try {
                // Check pending limit
                const pq = query(collection(db, "posts"), where("userId", "==", currentUser.uid), where("status", "==", "pending"));
                const psnap = await getDocs(pq);
                if (psnap.size >= 2) throw new Error("Wait for your pending requests to finish.");

                await addDoc(collection(db, "posts"), {
                    userId: currentUser.uid,
                    handle: userHandle,
                    userPfp: currentUser.photoURL,
                    prompt: prompt,
                    title: document.getElementById('inp-title').value || "Untitled",
                    isPublic: document.getElementById('inp-public').checked,
                    model: currentModel === 'sora' ? 'Sora 2' : 'Nano Banana',
                    duration: currentModel === 'sora' ? document.getElementById('inp-dur').value : null,
                    refImage: refImgData,
                    status: 'pending',
                    timestamp: serverTimestamp(),
                    likes: [],
                    views: 0
                });

                document.getElementById('inp-prompt').value = "";
                refImgData = null;
                document.getElementById('ref-indicator').innerText = "";
                navTo('profile'); // Go to profile to see pending state
            } catch (e) {
                alert(e.message);
            } finally {
                btn.disabled = false;
                btn.innerText = "GENERATE";
            }
        };

        // --- FEED LOGIC ---
        function loadFeed() {
            const q = query(collection(db, "posts"), where("status", "==", "completed"), where("isPublic", "==", true), orderBy("timestamp", "desc"), limit(20));
            onSnapshot(q, (snap) => {
                const container = document.getElementById('feed-list');
                // Simple approach: Rebuild feed on update (optimization: use diffing in real app)
                // We will just append new ones to avoid jitter
                if(container.innerHTML === "") {
                     snap.forEach(d => container.appendChild(createPostEl(d)));
                }
            });
        }

        function createPostEl(docSnap) {
            const d = docSnap.data();
            const el = document.createElement('div');
            el.className = 'post-item';
            el.id = `post-${docSnap.id}`;

            const isLiked = d.likes && d.likes.includes(currentUser.uid);
            
            // Media Loader
            const mediaWrap = document.createElement('div');
            mediaWrap.style.width = '100%'; mediaWrap.style.height = '100%'; mediaWrap.style.display='flex'; mediaWrap.style.justifyContent='center';
            
            resolveMedia(d.resultUrl).then(url => {
                let tag = '';
                if(d.model.includes('Sora')) {
                    tag = `<video src="${url}" class="post-media-main" autoplay muted loop playsinline></video>
                           <video src="${url}" class="post-media-bg" autoplay muted loop playsinline></video>`;
                } else {
                    tag = `<img src="${url}" class="post-media-main">
                           <img src="${url}" class="post-media-bg">`;
                }
                mediaWrap.innerHTML = tag;
            });

            el.innerHTML = `
                <div class="post-overlay">
                    <div class="post-content">
                        <div class="post-user">
                            <img src="${d.userPfp}" class="post-avatar">
                            <span class="post-handle">@${d.handle}</span>
                        </div>
                        <h3 class="post-title">${escapeHtml(d.title)}</h3>
                        <p class="post-prompt">${escapeHtml(d.prompt)}</p>
                        
                        <div class="post-actions">
                            <div class="action-pill ${isLiked ? 'liked' : ''}" onclick="toggleLike('${docSnap.id}')">
                                <i class="fa-${isLiked ? 'solid' : 'regular'} fa-heart"></i> ${d.likes ? d.likes.length : 0}
                            </div>
                            <div class="action-pill" onclick="openComments('${docSnap.id}')">
                                <i class="fa-regular fa-comment"></i> Comment
                            </div>
                            <div class="action-pill" onclick="copyPrompt('${escapeHtml(d.prompt)}')">
                                <i class="fa-solid fa-copy"></i> Copy Prompt
                            </div>
                        </div>
                    </div>
                </div>
            `;
            el.prepend(mediaWrap);
            return el;
        }

        // --- PROFILE LOGIC ---
        let profileUnsub;
        window.switchProfileTab = (tab) => {
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            event.target.classList.add('active');
            loadProfile(tab);
        };

        function loadProfile(tab) {
            if(profileUnsub) profileUnsub();
            const grid = document.getElementById('profile-grid');
            grid.innerHTML = '<div class="loader" style="margin:20px auto;"></div>';

            let q;
            if (tab === 'public') {
                q = query(collection(db, "posts"), where("userId", "==", currentUser.uid), where("status", "==", "completed"), where("isPublic", "==", true), orderBy("timestamp", "desc"));
            } else {
                // Private + Pending
                q = query(collection(db, "posts"), where("userId", "==", currentUser.uid), orderBy("timestamp", "desc"));
            }

            profileUnsub = onSnapshot(q, (snap) => {
                grid.innerHTML = "";
                document.getElementById('stat-posts').innerText = snap.size + " Posts";
                
                snap.forEach(d => {
                    const data = d.data();
                    // Filter logic for the "Private" tab to show drafts/pending/errors and private completed
                    if (tab === 'private' && (data.isPublic && data.status === 'completed')) return;

                    const item = document.createElement('div');
                    item.className = 'grid-item';
                    
                    let badge = data.status;
                    let badgeColor = data.status === 'completed' ? '#00ff88' : (data.status === 'error' ? '#ff2a2a' : '#ffe135');
                    
                    item.innerHTML = `<span class="status-badge" style="background:${badgeColor}">${badge}</span>`;
                    
                    if (data.status === 'completed' || data.status === 'copyright') {
                         resolveMedia(data.resultUrl).then(url => {
                             if(data.model.includes('Sora')) item.innerHTML += `<video src="${url}" muted loop onmouseover="this.play()" onmouseout="this.pause()"></video>`;
                             else item.innerHTML += `<img src="${url}">`;
                         }).catch(() => item.innerHTML += `<div style="padding:20px; font-size:0.8rem;">Media Error</div>`);
                    } else if (data.status === 'error') {
                        item.innerHTML += `<div style="padding:10px; color:#ff2a2a; font-size:0.8rem;">${data.errorMsg || "Failed"}</div>`;
                    } else {
                        item.innerHTML += `<div class="centered" style="height:100%"><div class="loader" style="width:20px; height:20px;"></div></div>`;
                    }

                    // Click to delete or view details (simplified)
                    item.onclick = () => {
                        if(confirm("Delete this draft/post?")) deleteDoc(doc(db, "posts", d.id));
                    }
                    grid.appendChild(item);
                });
            });
        }

        // --- SOCIAL ACTIONS ---
        window.toggleLike = async (postId) => {
            const ref = doc(db, "posts", postId);
            const p = await getDoc(ref);
            if (!p.exists()) return;
            const likes = p.data().likes || [];
            if (likes.includes(currentUser.uid)) {
                updateDoc(ref, { likes: arrayRemove(currentUser.uid) });
            } else {
                updateDoc(ref, { likes: arrayUnion(currentUser.uid) });
            }
        };

        window.openComments = (postId) => {
            activePostId = postId;
            document.getElementById('comments-sheet').classList.add('active');
            loadComments(postId);
        };
        window.closeComments = () => {
            document.getElementById('comments-sheet').classList.remove('active');
            activePostId = null;
        };
        
        function loadComments(postId) {
            const list = document.getElementById('cm-list');
            list.innerHTML = "Loading...";
            const q = query(collection(db, "posts", postId, "comments"), orderBy("timestamp"));
            onSnapshot(q, (snap) => {
                list.innerHTML = "";
                document.getElementById('cm-count').innerText = `(${snap.size})`;
                snap.forEach(c => {
                    const cd = c.data();
                    const d = document.createElement('div');
                    d.className = 'comment-item';
                    d.innerHTML = `<span class="comment-handle">@${cd.handle}</span> ${escapeHtml(cd.text)}`;
                    list.appendChild(d);
                });
            });
        }

        window.postComment = async () => {
            const inp = document.getElementById('cm-input');
            const txt = inp.value.trim();
            if(!txt || !activePostId) return;
            inp.value = "";
            await addDoc(collection(db, "posts", activePostId, "comments"), {
                userId: currentUser.uid,
                handle: userHandle,
                text: txt,
                timestamp: serverTimestamp()
            });
        };

        window.copyPrompt = (txt) => {
            navigator.clipboard.writeText(txt);
            alert("Prompt Copied!");
        };

        // --- ADMIN ---
        window.toggleAdmin = (show) => {
            const s = document.getElementById('screen-admin');
            show ? s.classList.add('active') : s.classList.remove('active');
        }

        function initAdmin() {
            const q = query(collection(db, "posts"), where("status", "==", "pending"), orderBy("timestamp", "asc"));
            onSnapshot(q, (snap) => {
                const list = document.getElementById('admin-feed');
                list.innerHTML = "";
                snap.forEach(d => {
                    const data = d.data();
                    const row = document.createElement('div');
                    row.className = 'admin-row';
                    
                    const time = data.timestamp ? data.timestamp.toDate().toLocaleString() : "Just now";
                    
                    row.innerHTML = `
                        <div class="admin-meta">
                            <span><i class="fa-solid fa-clock"></i> ${time}</span>
                            <span>@${data.handle}</span>
                        </div>
                        <div style="font-weight:bold; color:var(--primary);">${data.model} ${data.duration ? `(${data.duration}s)` : ''}</div>
                        <div style="background:#000; padding:10px; border-radius:5px; font-family:monospace; font-size:0.9rem;">
                            ${escapeHtml(data.prompt)} <i class="fa-solid fa-copy" style="float:right; cursor:pointer" onclick="navigator.clipboard.writeText(this.parentNode.innerText)"></i>
                        </div>
                        ${data.refImage ? `<div style="font-size:0.8rem; color:#00ff88;">[HAS REF IMAGE] - Check console if needed</div>` : ''}
                        
                        <div style="display:flex; gap:10px; margin-top:10px;">
                            <input type="text" id="res-${d.id}" placeholder="Result URL / Chunk ID" style="flex:1; background:#222; border:1px solid #444; color:white; padding:8px;">
                            <select id="stat-${d.id}" class="admin-status-select" onchange="checkErr(this, '${d.id}')">
                                <option value="completed">Success</option>
                                <option value="error">Error</option>
                                <option value="copyright" style="color:orange">Copyright</option>
                            </select>
                        </div>
                        <input type="text" id="err-${d.id}" class="hidden" placeholder="Custom Error / Copyright Reason" style="width:100%; background:#300; color:white; border:none; padding:8px; margin-top:5px;">
                        
                        <div style="display:flex; gap:10px; margin-top:10px;">
                            <label class="action-pill" style="font-size:0.8rem; padding:5px 10px;">
                                Upload File <input type="file" hidden onchange="adminUpload(this, '${d.id}')">
                            </label>
                            <button onclick="adminFinish('${d.id}')" style="flex:1; background:var(--primary); border:none; font-weight:bold; border-radius:5px;">SEND</button>
                        </div>
                        <div id="prog-${d.id}" style="height:3px; background:#00ff88; width:0%;"></div>
                    `;
                    list.appendChild(row);
                });
            });
        }

        window.checkErr = (sel, id) => {
            const inp = document.getElementById(`err-${id}`);
            if (sel.value === 'error' || sel.value === 'copyright') inp.classList.remove('hidden');
            else inp.classList.add('hidden');
        };

        window.adminUpload = async (input, id) => {
            const file = input.files[0];
            if(!file) return;
            try {
                const gid = await uploadFileAsChunks(file, (p) => {
                    document.getElementById(`prog-${id}`).style.width = p + "%";
                });
                document.getElementById(`res-${id}`).value = "group:" + gid;
            } catch(e) { alert("Upload fail"); }
        };

        window.adminFinish = async (id) => {
            const status = document.getElementById(`stat-${id}`).value;
            const resUrl = document.getElementById(`res-${id}`).value;
            const errMsg = document.getElementById(`err-${id}`).value;

            const updateData = { status: status };
            if (status === 'completed') updateData.resultUrl = resUrl;
            if (status === 'error' || status === 'copyright') updateData.errorMsg = errMsg || "Generation Failed";

            await updateDoc(doc(db, "posts", id), updateData);
        };

        // --- SYSTEM STATUS ---
        function listenSys() {
            onSnapshot(doc(db, "system", "status"), (snap) => {
                if (snap.exists()) {
                    sysState = snap.data();
                    document.getElementById('offline-banner').style.display = sysState.offline ? 'block' : 'none';
                    document.getElementById('traffic-banner').style.display = sysState.highTraffic ? 'block' : 'none';
                    
                    const offBtn = document.getElementById('btn-sys-offline');
                    const trfBtn = document.getElementById('btn-sys-traffic');
                    if(offBtn) offBtn.style.color = sysState.offline ? 'red' : 'white';
                    if(trfBtn) trfBtn.style.color = sysState.highTraffic ? 'orange' : 'white';
                }
            });
        }

        window.toggleSys = async (mode) => {
            const ref = doc(db, "system", "status");
            const snap = await getDoc(ref);
            let d = snap.exists() ? snap.data() : { offline: false, highTraffic: false };
            
            if(mode === 'offline') d.offline = !d.offline;
            if(mode === 'traffic') d.highTraffic = !d.highTraffic;
            
            await setDoc(ref, d);
        }

        // --- UTILS (CHUNKING PRESERVED) ---
        async function uploadFileAsChunks(file, onProgress) {
            const CHUNK_SIZE = 800000; 
            const base64 = await new Promise((resolve) => {
                const reader = new FileReader();
                reader.onload = (e) => resolve(e.target.result);
                reader.readAsDataURL(file);
            });
            const totalChunks = Math.ceil(base64.length / CHUNK_SIZE);
            const groupId = `group_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
            for (let i = 0; i < totalChunks; i++) {
                const chunkData = base64.slice(i * CHUNK_SIZE, (i + 1) * CHUNK_SIZE);
                await addDoc(collection(db, "ai_studio_files"), {
                    group: groupId, index: i, total: totalChunks, data: chunkData
                });
                onProgress(Math.round(((i + 1) / totalChunks) * 100));
            }
            return groupId;
        }

        async function resolveMedia(url) {
            if(!url) return "";
            if (!url.startsWith('group:')) return url;
            const groupId = url.split(":")[1];
            // Check cache or fetch
            const q = query(collection(db, "ai_studio_files"), where("group", "==", groupId), orderBy("index"));
            const s = await getDocs(q);
            let full = "";
            s.forEach(d => full += d.data().data);
            const res = await fetch(full);
            return URL.createObjectURL(await res.blob());
        }

        function escapeHtml(text) {
            if (!text) return "";
            return text.toString().replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;").replace(/"/g, "&quot;");
        }
    </script>
</body>
</html>
