<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>The Ai STudio - Social Update</title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600;800&family=Space+Grotesk:wght@300;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        :root {
            --bg-dark: #050508;
            --glass-panel: rgba(20, 20, 25, 0.6);
            --glass-border: rgba(255, 255, 255, 0.08);
            --glass-highlight: rgba(255, 255, 255, 0.15);
            --neon-blue: #00f2ff;
            --neon-purple: #bd00ff;
            --neon-yellow: #ffe135;
            --danger: #ff2a2a;
            --text-main: #ffffff;
            --text-muted: #888899;
            --primary: var(--neon-blue);
        }

        * { box-sizing: border-box; margin: 0; padding: 0; font-family: 'Outfit', sans-serif; -webkit-font-smoothing: antialiased; }
        body { background-color: var(--bg-dark); color: var(--text-main); height: 100vh; overflow: hidden; font-size: 14px; }
        
        /* SCROLLBAR */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.2); border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: var(--primary); }

        /* --- BACKGROUND FX --- */
        .background-fx {
            position: fixed; top: 0; left: 0; width: 100vw; height: 100vh;
            background: radial-gradient(circle at 10% 20%, rgba(189, 0, 255, 0.1), transparent 40%),
                        radial-gradient(circle at 90% 80%, rgba(0, 242, 255, 0.08), transparent 40%);
            z-index: -1; animation: bgPulse 15s infinite alternate; pointer-events: none;
        }
        @keyframes bgPulse { 0% { opacity: 0.6; transform: scale(1); } 100% { opacity: 1; transform: scale(1.1); } }

        /* --- LAYOUT SYSTEM --- */
        .screen {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            display: none; flex-direction: column; overflow: hidden;
            animation: fadeEnter 0.4s cubic-bezier(0.16, 1, 0.3, 1);
        }
        .screen.active { display: flex; }
        .centered { align-items: center; justify-content: center; }

        /* --- GLASS COMPONENTS --- */
        .glass-card {
            background: var(--glass-panel); backdrop-filter: blur(25px); -webkit-backdrop-filter: blur(25px);
            border: 1px solid var(--glass-border); border-radius: 20px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
            transition: 0.3s;
        }

        .btn {
            background: rgba(255,255,255,0.05); border: 1px solid var(--glass-border); color: white;
            padding: 10px 20px; border-radius: 12px; font-weight: 600; cursor: pointer;
            transition: all 0.2s; display: inline-flex; align-items: center; gap: 8px; justify-content: center;
            font-size: 0.9rem; text-transform: uppercase; letter-spacing: 0.5px;
        }
        .btn:hover { background: rgba(255,255,255,0.15); transform: translateY(-2px); border-color: var(--primary); box-shadow: 0 0 15px rgba(0, 242, 255, 0.2); }
        .btn:active { transform: scale(0.95); }
        .btn.primary { background: var(--primary); color: #000; border-color: var(--primary); text-shadow: none; }
        .btn.primary:hover { box-shadow: 0 0 20px var(--primary); background: white; }
        .btn.danger { border-color: var(--danger); color: var(--danger); }
        .btn.danger:hover { background: var(--danger); color: white; box-shadow: 0 0 15px var(--danger); }

        input, textarea, select {
            background: rgba(0,0,0,0.3); border: 1px solid var(--glass-border);
            color: white; padding: 12px 15px; border-radius: 10px; width: 100%;
            outline: none; transition: 0.3s; font-size: 1rem;
        }
        input:focus, textarea:focus { border-color: var(--primary); background: rgba(0,0,0,0.5); box-shadow: 0 0 10px rgba(0, 242, 255, 0.1); }

        /* --- APP NAVIGATION --- */
        .app-layout { display: flex; height: 100%; width: 100%; max-width: 1400px; margin: 0 auto; position: relative; }
        
        .sidebar {
            width: 80px; height: 100%; border-right: 1px solid var(--glass-border);
            display: flex; flex-direction: column; align-items: center; padding: 30px 0; gap: 30px;
            background: rgba(0,0,0,0.2); z-index: 100;
        }
        @media(max-width: 768px) {
            .sidebar { position: fixed; bottom: 0; left: 0; width: 100%; height: 70px; flex-direction: row; border-top: 1px solid var(--glass-border); border-right: none; justify-content: space-around; padding: 0; background: #000; }
        }

        .nav-item {
            width: 50px; height: 50px; border-radius: 14px; display: flex; align-items: center; justify-content: center;
            color: #666; font-size: 1.2rem; cursor: pointer; transition: 0.3s; position: relative;
        }
        .nav-item:hover { color: white; background: rgba(255,255,255,0.05); }
        .nav-item.active { color: var(--primary); background: rgba(0, 242, 255, 0.1); box-shadow: 0 0 15px rgba(0, 242, 255, 0.1); }
        .nav-item.active::after { content:''; position: absolute; right: -15px; width: 4px; height: 20px; background: var(--primary); border-radius: 4px 0 0 4px; }
        @media(max-width: 768px) { .nav-item.active::after { display: none; } }

        .main-content { flex: 1; overflow-y: auto; padding: 30px; position: relative; scroll-behavior: smooth; }
        @media(max-width: 768px) { .main-content { padding: 15px; padding-bottom: 90px; } }

        /* --- TAB SECTIONS --- */
        .tab-section { display: none; animation: fadeIn 0.3s ease; }
        .tab-section.active-tab { display: block; }

        /* --- CREATE STUDIO --- */
        .model-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; margin-bottom: 25px; }
        .model-option {
            background: rgba(255,255,255,0.03); border: 1px solid var(--glass-border); padding: 15px;
            border-radius: 15px; cursor: pointer; text-align: center; transition: 0.3s;
        }
        .model-option:hover { background: rgba(255,255,255,0.08); }
        .model-option.selected { border-color: var(--primary); background: rgba(0, 242, 255, 0.05); }
        
        .draft-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 20px; margin-top: 30px; }
        .draft-card {
            background: #000; border-radius: 12px; overflow: hidden; position: relative; border: 1px solid #333;
            transition: 0.3s; aspect-ratio: 16/9; cursor: pointer; group;
        }
        .draft-card:hover { transform: translateY(-5px); border-color: var(--primary); }
        .draft-img { width: 100%; height: 100%; object-fit: cover; }
        .draft-overlay {
            position: absolute; bottom: 0; left: 0; width: 100%; padding: 10px;
            background: linear-gradient(to top, black, transparent); opacity: 0; transition: 0.3s;
        }
        .draft-card:hover .draft-overlay { opacity: 1; }

        /* --- FEED --- */
        .feed-container { max-width: 600px; margin: 0 auto; }
        .post-card {
            margin-bottom: 30px; padding: 0; overflow: hidden;
        }
        .post-header { padding: 15px; display: flex; align-items: center; gap: 12px; border-bottom: 1px solid rgba(255,255,255,0.05); }
        .post-avatar { width: 40px; height: 40px; border-radius: 50%; object-fit: cover; border: 2px solid var(--primary); }
        .post-info h4 { font-size: 1rem; color: white; display: flex; align-items: center; gap: 5px; }
        .post-info span { font-size: 0.8rem; color: var(--text-muted); }
        .post-media { width: 100%; display: block; background: #000; max-height: 500px; object-fit: contain; }
        .post-actions { padding: 15px; display: flex; gap: 20px; font-size: 1.2rem; color: #aaa; }
        .action-btn { cursor: pointer; transition: 0.2s; display: flex; align-items: center; gap: 6px; }
        .action-btn:hover { color: white; }
        .action-btn.liked { color: #ff2a2a; }
        .post-content { padding: 0 15px 15px 15px; }
        .post-title { font-weight: 700; margin-bottom: 5px; font-size: 1.1rem; }
        .post-desc { color: #ccc; font-size: 0.95rem; line-height: 1.4; }

        /* --- USER PROFILE --- */
        .profile-header { text-align: center; margin-bottom: 40px; padding: 40px 20px; position: relative; overflow: hidden; }
        .profile-bg { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: linear-gradient(45deg, rgba(0,242,255,0.1), rgba(189,0,255,0.1)); z-index: -1; }
        .profile-pic-lg { width: 100px; height: 100px; border-radius: 50%; border: 3px solid var(--primary); margin: 0 auto 15px; object-fit: cover; box-shadow: 0 0 30px rgba(0,242,255,0.3); }
        .stat-box { display: flex; justify-content: center; gap: 30px; margin: 20px 0; }
        .stat-item { text-align: center; }
        .stat-val { font-weight: 800; font-size: 1.2rem; display: block; }
        .stat-label { font-size: 0.8rem; color: #888; text-transform: uppercase; }

        /* --- ONBOARDING --- */
        #screen-onboarding { z-index: 2000; background: #000; }
        .setup-box { max-width: 450px; width: 90%; text-align: center; padding: 40px; }
        .pfp-grid { display: flex; justify-content: center; gap: 10px; margin: 20px 0; flex-wrap: wrap; }
        .pfp-option { width: 50px; height: 50px; border-radius: 50%; cursor: pointer; border: 2px solid transparent; opacity: 0.5; transition: 0.3s; }
        .pfp-option:hover { opacity: 1; }
        .pfp-option.selected { border-color: var(--primary); opacity: 1; transform: scale(1.1); }

        /* --- MODALS --- */
        .modal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.85); backdrop-filter: blur(5px);
            z-index: 5000; display: none; align-items: center; justify-content: center;
        }
        .modal.open { display: flex; animation: fadeIn 0.3s; }
        .modal-content {
            background: #101014; border: 1px solid #333; padding: 30px; border-radius: 20px;
            width: 90%; max-width: 500px; position: relative; box-shadow: 0 0 50px rgba(0,0,0,0.8);
        }

        /* --- UTILS --- */
        .hidden { display: none !important; }
        .logo-text { font-family: 'Space Grotesk'; font-weight: 700; font-size: 1.5rem; letter-spacing: -1px; }
        .logo-highlight { color: var(--primary); }
        .badge { background: var(--primary); color: #000; padding: 2px 6px; border-radius: 4px; font-size: 0.7rem; font-weight: bold; margin-left: 5px; }

        @keyframes spin { 100% { transform: rotate(360deg); } }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes fadeEnter { from { opacity: 0; scale: 0.95; } to { opacity: 1; scale: 1; } }

        /* Loaders */
        .loader { width: 30px; height: 30px; border: 3px solid rgba(255,255,255,0.1); border-top-color: var(--primary); border-radius: 50%; animation: spin 0.8s linear infinite; }
    </style>
</head>
<body>

    <div class="background-fx"></div>

    <div id="toast" style="position:fixed; bottom:30px; left:50%; transform:translateX(-50%); background:white; color:black; padding:12px 25px; border-radius:30px; font-weight:bold; z-index:9999; display:none; box-shadow: 0 10px 40px rgba(0,0,0,0.5);"></div>

    <div id="screen-loading" class="screen active centered" style="background: #000; z-index: 9999;">
        <div class="loader" style="width: 50px; height: 50px;"></div>
        <p style="margin-top: 20px; font-family: 'Space Grotesk'; letter-spacing: 2px; color: #666;">SYSTEM INITIALIZING</p>
    </div>

    <div id="screen-auth" class="screen centered" style="z-index: 5000;">
        <div class="glass-card setup-box">
            <h1 class="logo-text" style="font-size: 2.5rem; margin-bottom: 10px;">The Ai <span class="logo-highlight">STudio</span></h1>
            <p style="color: #888; margin-bottom: 30px;">Login to access the creative network.</p>
            
            <button id="btn-google" class="btn" style="width: 100%; justify-content: center; background: white; color: black; border: none; margin-bottom: 15px;">
                <i class="fa-brands fa-google"></i> Continue with Google
            </button>
            <div style="display:flex; align-items:center; gap:10px; margin: 20px 0; opacity: 0.5;">
                <div style="height:1px; background:white; flex:1;"></div><span>OR</span><div style="height:1px; background:white; flex:1;"></div>
            </div>
            <input type="email" id="email-in" placeholder="Email" style="margin-bottom:10px;">
            <input type="password" id="pass-in" placeholder="Password" style="margin-bottom:20px;">
            <button id="btn-email-login" class="btn primary" style="width: 100%;">Login / Signup</button>
            <p id="auth-msg" style="color: var(--danger); margin-top: 15px; font-size: 0.9rem;"></p>
        </div>
    </div>

    <div id="screen-onboarding" class="screen centered">
        <div class="glass-card setup-box">
            <h2 style="margin-bottom: 10px;">Setup Profile</h2>
            <p style="color:#888; margin-bottom: 20px;">Create your identity on Ai STudio.</p>
            
            <div class="pfp-grid" id="pfp-selector">
                </div>
            
            <div style="text-align: left; margin-bottom: 15px;">
                <label style="font-size:0.8rem; margin-left: 5px; color: var(--primary);">UNIQUE USERNAME</label>
                <input type="text" id="setup-username" placeholder="@username" maxlength="20">
                <span id="username-check" style="font-size: 0.8rem; color: #666; margin-left: 5px;">Letters & numbers only.</span>
            </div>
            
            <div style="text-align: left; margin-bottom: 25px;">
                <label style="font-size:0.8rem; margin-left: 5px;">DISPLAY NAME</label>
                <input type="text" id="setup-display" placeholder="Display Name (Can be duplicate)" maxlength="30">
            </div>

            <button id="btn-finish-setup" class="btn primary" style="width: 100%;">ENTER STUDIO</button>
        </div>
    </div>

    <div id="screen-app" class="screen">
        <div class="app-layout">
            <div class="sidebar glass-card">
                <div class="nav-item active" onclick="switchTab('create')" title="Studio">
                    <i class="fa-solid fa-wand-magic-sparkles"></i>
                </div>
                <div class="nav-item" onclick="switchTab('feed')" title="Feed">
                    <i class="fa-solid fa-earth-americas"></i>
                </div>
                <div class="nav-item" onclick="switchTab('profile')" title="Profile">
                    <img id="nav-pfp" src="" style="width:28px; height:28px; border-radius:50%; object-fit:cover; border: 1px solid var(--primary);">
                </div>
                <div style="flex:1;"></div>
                <div class="nav-item" onclick="toggleAdmin(true)" id="admin-btn" style="display:none; color: var(--danger);">
                    <i class="fa-solid fa-terminal"></i>
                </div>
                <div class="nav-item" onclick="doLogout()" title="Logout">
                    <i class="fa-solid fa-right-from-bracket"></i>
                </div>
            </div>

            <div class="main-content">
                
                <div id="tab-create" class="tab-section active-tab">
                    <header style="display:flex; justify-content:space-between; align-items:center; margin-bottom:30px;">
                        <div>
                            <h1 class="logo-text">Studio <span class="logo-highlight">V5</span></h1>
                            <p style="color:#666;">Create next-gen content.</p>
                        </div>
                        <div style="text-align:right;">
                            <span class="badge" id="quota-display">2 SLOTS AVAIL</span>
                        </div>
                    </header>

                    <div class="glass-card" style="padding: 25px;">
                        <div class="model-grid">
                            <div class="model-option selected" onclick="selectModel('banana')" id="mod-banana">
                                <i class="fa-solid fa-image fa-2x" style="margin-bottom:10px; color:var(--neon-yellow);"></i>
                                <h3>Nano Banana</h3>
                            </div>
                            <div class="model-option" onclick="selectModel('sora')" id="mod-sora">
                                <i class="fa-solid fa-video fa-2x" style="margin-bottom:10px; color:var(--neon-blue);"></i>
                                <h3>Sora 2</h3>
                            </div>
                        </div>

                        <div id="upload-area" style="margin-bottom: 15px;">
                             <label class="btn" style="width:100%; justify-content: space-between; background: rgba(255,255,255,0.02);">
                                <span><i class="fa-solid fa-upload"></i> Reference Image (Optional)</span>
                                <input type="file" id="inp-file" accept="image/*" style="display:none;">
                                <span id="file-status" style="font-size:0.8rem; color: #666;">No file</span>
                             </label>
                        </div>
                        
                        <textarea id="inp-prompt" placeholder="Describe your imagination..." style="min-height: 100px; margin-bottom: 15px;"></textarea>
                        
                        <div style="display:flex; justify-content: flex-end;">
                            <button id="btn-generate" class="btn primary" style="padding: 12px 30px;" onclick="submitGeneration()">
                                <i class="fa-solid fa-bolt"></i> GENERATE
                            </button>
                        </div>
                    </div>

                    <h3 style="margin-top: 40px; border-bottom: 1px solid var(--glass-border); padding-bottom: 10px;">
                        My Drafts <span style="font-weight: 400; font-size: 0.9rem; color: #666;">(Private)</span>
                    </h3>
                    <div id="drafts-list" class="draft-grid">
                        </div>
                </div>

                <div id="tab-feed" class="tab-section">
                    <h2 style="margin-bottom: 20px; text-align: center;">Global Feed</h2>
                    <div id="feed-list" class="feed-container">
                        <div style="text-align: center; color: #666; padding: 20px;">Loading feed...</div>
                    </div>
                </div>

                <div id="tab-profile" class="tab-section">
                    <div class="glass-card profile-header">
                        <div class="profile-bg"></div>
                        <img id="profile-img-lg" class="profile-pic-lg" src="">
                        <h2 id="profile-name">User</h2>
                        <p id="profile-handle" style="color: var(--primary); margin-bottom: 10px;">@username</p>
                        <p id="profile-bio" style="color: #ccc; max-width: 500px; margin: 0 auto;">No bio yet.</p>
                        
                        <div class="stat-box">
                            <div class="stat-item"><span class="stat-val" id="stat-posts">0</span><span class="stat-label">Posts</span></div>
                            <div class="stat-item"><span class="stat-val" id="stat-followers">0</span><span class="stat-label">Followers</span></div>
                            <div class="stat-item"><span class="stat-val" id="stat-following">0</span><span class="stat-label">Following</span></div>
                        </div>
                    </div>
                    
                    <h3 style="margin-bottom: 20px;">Published Posts</h3>
                    <div id="user-posts-grid" class="draft-grid"></div>
                </div>

            </div>
        </div>
    </div>

    <div id="screen-admin" class="screen" style="background: #0f0f13; padding: 30px; z-index: 3000;">
        <div style="display:flex; justify-content:space-between; margin-bottom: 20px;">
            <h2 style="color: var(--danger);">ADMIN TERMINAL</h2>
            <button onclick="toggleAdmin(false)" class="btn">CLOSE</button>
        </div>
        <div id="admin-queue" style="display: flex; flex-direction: column; gap: 10px;"></div>
    </div>

    <div id="modal-publish" class="modal">
        <div class="glass-card modal-content">
            <h2 style="margin-bottom: 15px;">Publish to Feed</h2>
            <div id="publish-preview-area" style="height: 150px; background: #000; border-radius: 10px; margin-bottom: 15px; display: flex; align-items: center; justify-content: center;"></div>
            
            <input type="text" id="pub-title" placeholder="Give it a title..." style="margin-bottom: 10px;">
            <textarea id="pub-desc" placeholder="Caption..." style="height: 80px; margin-bottom: 20px;"></textarea>
            
            <div style="display:flex; gap: 10px;">
                <button class="btn" style="flex:1;" onclick="closeModal('modal-publish')">Cancel</button>
                <button class="btn primary" style="flex:1;" id="btn-confirm-pub" onclick="confirmPublish()">POST</button>
            </div>
        </div>
    </div>

    <div id="modal-view" class="modal">
        <div class="modal-content" style="background: transparent; border: none; box-shadow: none; text-align: center; max-width: 90%;">
            <div id="view-container" style="max-height: 80vh; margin-bottom: 20px;"></div>
            <button class="btn" onclick="closeModal('modal-view')">Close</button>
        </div>
        <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-app.js";
    import { getAuth, signInWithPopup, signInWithEmailAndPassword, createUserWithEmailAndPassword, GoogleAuthProvider, onAuthStateChanged, signOut, updateProfile } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-auth.js";
    import { getFirestore, collection, addDoc, query, where, onSnapshot, serverTimestamp, updateDoc, doc, deleteDoc, orderBy, limit, getDocs, setDoc, getDoc, increment, arrayUnion, arrayRemove } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-firestore.js";

    // --- CONFIG ---
    const firebaseConfig = {
        apiKey: "AIzaSyDQacpiI3oIqOUx8ciMfdlQgBtHZEVdcMo",
        authDomain: "anymousxe-aistudio.firebaseapp.com",
        projectId: "anymousxe-aistudio",
        storageBucket: "anymousxe-aistudio.firebasestorage.app",
        messagingSenderId: "518478280058",
        appId: "1:518478280058:web:422404fc54c21e5ea312c3"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    const provider = new GoogleAuthProvider();
    const ADMIN_EMAIL = "anymousxe.info@gmail.com";

    // --- AUDIO FX ---
    const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    function playSound(type) {
        if(audioCtx.state === 'suspended') audioCtx.resume();
        const osc = audioCtx.createOscillator();
        const gain = audioCtx.createGain();
        osc.connect(gain);
        gain.connect(audioCtx.destination);
        
        if (type === 'click') {
            osc.frequency.setValueAtTime(400, audioCtx.currentTime);
            osc.frequency.exponentialRampToValueAtTime(600, audioCtx.currentTime + 0.1);
            gain.gain.setValueAtTime(0.05, audioCtx.currentTime);
            gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.1);
            osc.start(); osc.stop(audioCtx.currentTime + 0.1);
        } else if (type === 'success') {
            osc.type = 'sine';
            osc.frequency.setValueAtTime(500, audioCtx.currentTime);
            osc.frequency.linearRampToValueAtTime(1000, audioCtx.currentTime + 0.1);
            gain.gain.setValueAtTime(0.05, audioCtx.currentTime);
            gain.gain.linearRampToValueAtTime(0, audioCtx.currentTime + 0.3);
            osc.start(); osc.stop(audioCtx.currentTime + 0.3);
        }
    }
    
    document.querySelectorAll('button, .nav-item, .model-option, .draft-card').forEach(b => {
        b.addEventListener('click', () => playSound('click'));
    });

    // --- STATE ---
    let currentUser = null;
    let userData = null; // Profile data from DB
    let selectedModel = 'banana';
    let selectedRefFile = null;
    let publishingId = null; // ID of draft being published

    // --- DOM HELPERS ---
    const get = (id) => document.getElementById(id);
    const showScreen = (id) => {
        document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
        get(id).classList.add('active');
    };
    const showToast = (msg) => {
        const t = get('toast');
        t.innerText = msg; t.style.display = 'block';
        setTimeout(() => t.style.display = 'none', 3000);
        playSound('success');
    };
    window.switchTab = (tab) => {
        document.querySelectorAll('.tab-section').forEach(t => t.classList.remove('active-tab'));
        get('tab-' + tab).classList.add('active-tab');
        document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
        document.querySelector(`.nav-item[onclick="switchTab('${tab}')"]`).classList.add('active');
    };
    window.closeModal = (id) => get(id).classList.remove('open');
    window.selectModel = (m) => {
        selectedModel = m;
        document.querySelectorAll('.model-option').forEach(o => o.classList.remove('selected'));
        get('mod-' + m).classList.add('selected');
        document.documentElement.style.setProperty('--primary', m === 'banana' ? '#ffe135' : '#00f2ff');
    };
    window.toggleAdmin = (show) => {
        if(show) showScreen('screen-admin');
        else showScreen('screen-app');
    };

    // --- AUTH FLOW ---
    onAuthStateChanged(auth, async (user) => {
        if (user) {
            currentUser = user;
            if (user.email === ADMIN_EMAIL) get('admin-btn').style.display = 'flex';
            
            // Check if user has a profile doc
            const userDocRef = doc(db, "users", user.uid);
            const userSnap = await getDoc(userDocRef);

            if (userSnap.exists()) {
                userData = userSnap.data();
                initApp(); // Go to App
            } else {
                showScreen('screen-onboarding'); // Go to Setup
                initOnboarding();
            }
        } else {
            showScreen('screen-auth');
        }
        get('screen-loading').classList.remove('active');
    });

    // Login Handlers
    get('btn-google').onclick = () => signInWithPopup(auth, provider).catch(e => get('auth-msg').innerText = e.message);
    get('btn-email-login').onclick = async () => {
        const e = get('email-in').value, p = get('pass-in').value;
        try { await signInWithEmailAndPassword(auth, e, p); } 
        catch { try { await createUserWithEmailAndPassword(auth, e, p); } catch(err) { get('auth-msg').innerText = err.message; } }
    };
    window.doLogout = () => signOut(auth).then(()=>window.location.reload());

    // --- ONBOARDING LOGIC ---
    let chosenPfp = "";
    function initOnboarding() {
        const avatars = [
            "https://api.dicebear.com/9.x/notionists/svg?seed=Felix",
            "https://api.dicebear.com/9.x/notionists/svg?seed=Silo",
            "https://api.dicebear.com/9.x/notionists/svg?seed=Luna",
            "https://api.dicebear.com/9.x/notionists/svg?seed=Max",
            "https://api.dicebear.com/9.x/notionists/svg?seed=Zoey"
        ];
        const grid = get('pfp-selector');
        grid.innerHTML = "";
        avatars.forEach(url => {
            const img = document.createElement('img');
            img.src = url; img.className = "pfp-option";
            img.onclick = () => {
                document.querySelectorAll('.pfp-option').forEach(i => i.classList.remove('selected'));
                img.classList.add('selected');
                chosenPfp = url;
            }
            grid.appendChild(img);
        });
        if(currentUser.photoURL) chosenPfp = currentUser.photoURL; // Default
    }

    get('btn-finish-setup').onclick = async () => {
        const username = get('setup-username').value.toLowerCase().replace(/[^a-z0-9]/g, '');
        const display = get('setup-display').value;
        
        if (username.length < 3 || !display) return alert("Please fill all fields properly.");
        if (!chosenPfp) return alert("Select a profile picture.");

        // Check Uniqueness
        const q = query(collection(db, "users"), where("username", "==", username));
        const snap = await getDocs(q);
        if (!snap.empty) return alert("Username taken!");

        // Create Profile
        try {
            await setDoc(doc(db, "users", currentUser.uid), {
                uid: currentUser.uid,
                username: username,
                displayName: display,
                photoURL: chosenPfp,
                bio: "Just joined Ai STudio.",
                followers: [],
                following: [],
                postsCount: 0,
                joinedAt: serverTimestamp()
            });
            await updateProfile(currentUser, { displayName: display, photoURL: chosenPfp });
            window.location.reload();
        } catch(e) { alert(e.message); }
    };

    // --- APP INITIALIZATION ---
    function initApp() {
        showScreen('screen-app');
        // Update UI with User Data
        get('nav-pfp').src = userData.photoURL;
        get('profile-img-lg').src = userData.photoURL;
        get('profile-name').innerText = userData.displayName;
        get('profile-handle').innerText = "@" + userData.username;
        get('profile-bio').innerText = userData.bio;
        get('stat-followers').innerText = userData.followers.length;
        get('stat-following').innerText = userData.following.length;

        listenToDrafts();
        listenToFeed();
        loadUserPosts();
        if(currentUser.email === ADMIN_EMAIL) listenToAdmin();
    }

    // --- GENERATION LOGIC ---
    // Chunking logic for large file uploads
    async function uploadFileAsChunks(file) {
        const CHUNK_SIZE = 800000;
        const reader = new FileReader();
        const base64 = await new Promise(r => { reader.onload = e => r(e.target.result); reader.readAsDataURL(file); });
        const totalChunks = Math.ceil(base64.length / CHUNK_SIZE);
        const groupId = `group_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;

        for (let i = 0; i < totalChunks; i++) {
            await addDoc(collection(db, "ai_studio_files"), {
                group: groupId, index: i, data: base64.slice(i * CHUNK_SIZE, (i + 1) * CHUNK_SIZE)
            });
            get('file-status').innerText = `Uploading ${Math.round(((i+1)/totalChunks)*100)}%`;
        }
        return "group:" + groupId;
    }

    get('inp-file').onchange = (e) => {
        if(e.target.files[0]) {
            selectedRefFile = e.target.files[0];
            get('file-status').innerText = selectedRefFile.name;
        }
    };

    window.submitGeneration = async () => {
        const prompt = get('inp-prompt').value;
        if(!prompt) return showToast("Enter a prompt!");
        
        get('btn-generate').disabled = true;
        get('btn-generate').innerText = "Processing...";

        try {
            // Check Limit
            const q = query(collection(db, "ai_studio_requests"), where("userId", "==", currentUser.uid), where("status", "==", "pending"));
            const snap = await getDocs(q);
            if(snap.size >= 2) throw new Error("Slot limit reached (2/2).");

            let refImgUrl = null;
            if(selectedRefFile) refImgUrl = await uploadFileAsChunks(selectedRefFile);

            await addDoc(collection(db, "ai_studio_requests"), {
                userId: currentUser.uid,
                userName: userData.displayName,
                prompt: prompt,
                model: selectedModel === 'banana' ? "Nano Banana" : "Sora 2",
                status: 'pending',
                timestamp: serverTimestamp(),
                refImage: refImgUrl
            });
            
            get('inp-prompt').value = "";
            selectedRefFile = null;
            get('file-status').innerText = "No file";
            showToast("Started Generation");
        } catch(e) {
            alert(e.message);
        } finally {
            get('btn-generate').disabled = false;
            get('btn-generate').innerHTML = `<i class="fa-solid fa-bolt"></i> GENERATE`;
        }
    };

    // --- DRAFTS & PUBLISHING ---
    function listenToDrafts() {
        const q = query(collection(db, "ai_studio_requests"), where("userId", "==", currentUser.uid), orderBy("timestamp", "desc"));
        onSnapshot(q, (snap) => {
            const grid = get('drafts-list');
            grid.innerHTML = "";
            snap.forEach(docSnap => {
                const d = docSnap.data();
                const id = docSnap.id;
                const isReady = d.status === 'completed';
                const isError = d.status === 'error';
                
                let mediaDisplay = `<div style="display:flex; height:100%; align-items:center; justify-content:center; color:#555;"><div class="loader"></div></div>`;
                
                if (isError) mediaDisplay = `<div style="display:flex; height:100%; align-items:center; justify-content:center; color:var(--danger); background:#2a0505;"><i class="fa-solid fa-triangle-exclamation fa-2x"></i></div>`;
                else if (isReady) {
                    if(d.resultUrl.includes("group:")) {
                        // We need to fetch blob (simplified for UI speed: usually handled by async loader)
                        mediaDisplay = `<div class="centered" style="height:100%;" id="thumb-${id}"><i class="fa-solid fa-file-arrow-down"></i> Loading Media...</div>`;
                        fetchBlob(d.resultUrl).then(url => {
                            const el = get(`thumb-${id}`);
                            if(el) {
                                if(d.model.includes("Sora")) el.parentNode.innerHTML = `<video src="${url}" class="draft-img" muted loop onmouseover="this.play()" onmouseout="this.pause()"></video>`;
                                else el.parentNode.innerHTML = `<img src="${url}" class="draft-img">`;
                            }
                        });
                    } else {
                         if(d.model.includes("Sora")) mediaDisplay = `<video src="${d.resultUrl}" class="draft-img" muted loop onmouseover="this.play()" onmouseout="this.pause()"></video>`;
                         else mediaDisplay = `<img src="${d.resultUrl}" class="draft-img">`;
                    }
                }

                const card = document.createElement('div');
                card.className = "draft-card";
                card.innerHTML = `
                    ${mediaDisplay}
                    <div class="draft-overlay">
                        <div style="font-weight:bold; font-size:0.9rem; margin-bottom:5px;">${d.prompt}</div>
                        <div style="display:flex; gap:10px;">
                            ${isReady ? `<button class="btn primary" style="padding:5px 10px; font-size:0.7rem;" onclick="openPublish('${id}')">PUBLISH</button>` : `<span class="badge" style="background:#333; color:#aaa;">${d.status}</span>`}
                            <button class="btn danger" style="padding:5px 10px; font-size:0.7rem;" onclick="deleteDraft('${id}')"><i class="fa-solid fa-trash"></i></button>
                        </div>
                    </div>
                `;
                grid.appendChild(card);
            });
        });
    }

    async function fetchBlob(groupStr) {
        if(!groupStr.startsWith("group:")) return groupStr;
        const groupId = groupStr.split(":")[1];
        const q = query(collection(db, "ai_studio_files"), where("group", "==", groupId), orderBy("index"));
        const snap = await getDocs(q);
        let data = "";
        snap.forEach(d => data += d.data().data);
        return fetch(data).then(r => r.blob()).then(b => URL.createObjectURL(b));
    }

    window.deleteDraft = async (id) => {
        if(confirm("Delete draft?")) await deleteDoc(doc(db, "ai_studio_requests", id));
    };

    window.openPublish = async (id) => {
        publishingId = id;
        get('modal-publish').classList.add('open');
        get('publish-preview-area').innerHTML = "Loading preview...";
        // Fetch data to preview
        const d = (await getDoc(doc(db, "ai_studio_requests", id))).data();
        let url = d.resultUrl;
        if(url.startsWith("group:")) url = await fetchBlob(url);
        
        if(d.model.includes("Sora")) get('publish-preview-area').innerHTML = `<video src="${url}" autoplay muted loop style="height:100%;"></video>`;
        else get('publish-preview-area').innerHTML = `<img src="${url}" style="height:100%;">`;
    };

    window.confirmPublish = async () => {
        const title = get('pub-title').value;
        const desc = get('pub-desc').value;
        if(!title) return showToast("Add a title");
        
        get('btn-confirm-pub').disabled = true;
        
        try {
            const draftRef = doc(db, "ai_studio_requests", publishingId);
            const draftSnap = await getDoc(draftRef);
            const draftData = draftSnap.data();

            // Create Post
            await addDoc(collection(db, "posts"), {
                authorId: currentUser.uid,
                authorName: userData.displayName,
                authorPfp: userData.photoURL,
                authorUser: userData.username,
                mediaUrl: draftData.resultUrl, // Keep internal reference
                type: draftData.model.includes("Sora") ? "video" : "image",
                title: title,
                description: desc,
                likes: [],
                timestamp: serverTimestamp()
            });

            // Update User Stats
            await updateDoc(doc(db, "users", currentUser.uid), { postsCount: increment(1) });
            
            // Delete Draft (or keep it? Let's delete to move it)
            await deleteDoc(draftRef);
            
            closeModal('modal-publish');
            showToast("PUBLISHED TO FEED!");
            switchTab('feed');
        } catch(e) { alert(e.message); }
        finally { get('btn-confirm-pub').disabled = false; }
    };

    // --- FEED LOGIC ---
    function listenToFeed() {
        const q = query(collection(db, "posts"), orderBy("timestamp", "desc"), limit(20));
        onSnapshot(q, (snap) => {
            const list = get('feed-list');
            list.innerHTML = "";
            snap.forEach(async (docSnap) => {
                const p = docSnap.data();
                const pid = docSnap.id;
                const isLiked = p.likes.includes(currentUser.uid);
                
                let mediaEl = "";
                // Async load media
                let finalUrl = p.mediaUrl;
                if(finalUrl.startsWith("group:")) finalUrl = await fetchBlob(finalUrl); // This is inefficient in a loop, but works for prototype
                
                if(p.type === 'video') mediaEl = `<video src="${finalUrl}" class="post-media" controls></video>`;
                else mediaEl = `<img src="${finalUrl}" class="post-media">`;

                const card = document.createElement('div');
                card.className = "glass-card post-card";
                card.innerHTML = `
                    <div class="post-header">
                        <img src="${p.authorPfp}" class="post-avatar">
                        <div class="post-info">
                            <h4>${p.authorName} ${p.authorId === currentUser.uid ? '<span class="badge">YOU</span>' : ''}</h4>
                            <span>@${p.authorUser}</span>
                        </div>
                    </div>
                    ${mediaEl}
                    <div class="post-actions">
                        <div class="action-btn ${isLiked ? 'liked' : ''}" onclick="toggleLike('${pid}')">
                            <i class="${isLiked ? 'fa-solid' : 'fa-regular'} fa-heart"></i> ${p.likes.length}
                        </div>
                        <div class="action-btn"><i class="fa-regular fa-comment"></i> Comment</div>
                    </div>
                    <div class="post-content">
                        <div class="post-title">${p.title}</div>
                        <div class="post-desc">${p.description}</div>
                    </div>
                `;
                list.appendChild(card);
            });
        });
    }

    window.toggleLike = async (pid) => {
        const ref = doc(db, "posts", pid);
        const p = (await getDoc(ref)).data();
        if(p.likes.includes(currentUser.uid)) {
            await updateDoc(ref, { likes: arrayRemove(currentUser.uid) });
        } else {
            await updateDoc(ref, { likes: arrayUnion(currentUser.uid) });
            playSound('success'); // Little pop sound
        }
    };

    async function loadUserPosts() {
        const q = query(collection(db, "posts"), where("authorId", "==", currentUser.uid), orderBy("timestamp", "desc"));
        const snap = await getDocs(q);
        const grid = get('user-posts-grid');
        grid.innerHTML = "";
        get('stat-posts').innerText = snap.size;
        
        snap.forEach(async (d) => {
            const p = d.data();
            let url = p.mediaUrl;
            if(url.startsWith("group:")) url = await fetchBlob(url);
            
            const div = document.createElement('div');
            div.className = "draft-card";
            if(p.type === 'video') div.innerHTML = `<video src="${url}" class="draft-img"></video>`;
            else div.innerHTML = `<img src="${url}" class="draft-img">`;
            grid.appendChild(div);
        });
    }

    // --- ADMIN LOGIC ---
    function listenToAdmin() {
        const q = query(collection(db, "ai_studio_requests"), where("status", "==", "pending"));
        onSnapshot(q, (snap) => {
            const qDiv = get('admin-queue');
            qDiv.innerHTML = "";
            snap.forEach(async d => {
                const data = d.data();
                const id = d.id;
                
                // Load Ref Image if exists
                let refImgHtml = "";
                if(data.refImage) {
                    let url = data.refImage;
                    if(url.startsWith("group:")) url = await fetchBlob(url);
                    refImgHtml = `<img src="${url}" style="height:50px; border-radius:5px; margin:5px 0;">`;
                }

                const row = document.createElement('div');
                row.className = "glass-card";
                row.style.padding = "10px";
                row.innerHTML = `
                    <div style="color:var(--primary); font-weight:bold;">${data.model} - ${data.userName}</div>
                    <div style="font-size:0.9rem; margin:5px 0; color:#ccc;">${data.prompt}</div>
                    ${refImgHtml}
                    <div style="display:flex; gap:10px; margin-top:10px;">
                        <input type="text" id="res-${id}" placeholder="Result URL..." style="font-size:0.8rem;">
                        <label class="btn" style="padding:5px;">
                            <i class="fa-solid fa-upload"></i> <input type="file" onchange="uploadAdminResult(this, '${id}')" style="display:none;">
                        </label>
                    </div>
                    <button class="btn primary" style="width:100%; margin-top:5px;" onclick="finishAdmin('${id}')">SEND</button>
                `;
                qDiv.appendChild(row);
            });
        });
    }

    window.uploadAdminResult = async (inp, id) => {
        if(inp.files[0]) {
            const url = await uploadFileAsChunks(inp.files[0]);
            get(`res-${id}`).value = url;
            inp.parentElement.style.background = "#00ff88";
        }
    };

    window.finishAdmin = async (id) => {
        const url = get(`res-${id}`).value;
        if(url) await updateDoc(doc(db, "ai_studio_requests", id), { status: 'completed', resultUrl: url });
    };

</script>
    </div>

    </body>
</html>
