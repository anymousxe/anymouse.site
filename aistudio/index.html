<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>The Ai STudio - V6 (Sora Style)</title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600;800&family=Space+Grotesk:wght@300;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        :root {
            --bg-dark: #050508;
            --glass: rgba(255, 255, 255, 0.05);
            --glass-strong: #1a1a20;
            --glass-border: rgba(255, 255, 255, 0.1);
            --banana-yellow: #ffe135;
            --sora-cyan: #00f2ff;
            --danger: #ff2a2a;
            --text-main: #ffffff;
            --primary: var(--banana-yellow);
        }

        * { box-sizing: border-box; margin: 0; padding: 0; font-family: 'Outfit', sans-serif; }
        body { background-color: var(--bg-dark); color: var(--text-main); height: 100vh; overflow: hidden; }

        /* --- UTILS --- */
        .hidden { display: none !important; }
        .centered { display: flex; align-items: center; justify-content: center; }

        /* --- BANNERS --- */
        #offline-banner, #queue-banner {
            position: fixed; top: 0; left: 0; width: 100%; 
            text-align: center; padding: 8px; font-weight: 800; letter-spacing: 1px;
            z-index: 99999; display: none; font-family: 'Space Grotesk'; text-transform: uppercase;
        }
        #offline-banner { background: repeating-linear-gradient(45deg, #ff2a2a, #ff2a2a 10px, #cc0000 10px, #cc0000 20px); }
        #queue-banner { background: #ffcc00; color: black; top: 35px; /* Below offline banner if both active */ }

        /* --- BACKGROUND --- */
        .background-fx {
            position: fixed; top: 0; left: 0; width: 100vw; height: 100vh;
            background: radial-gradient(circle at 15% 50%, rgba(86, 0, 245, 0.15), transparent 25%),
                        radial-gradient(circle at 85% 30%, rgba(0, 242, 255, 0.1), transparent 25%);
            z-index: -1;
        }

        /* --- LAYOUT --- */
        .screen {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            display: none; flex-direction: column; overflow-y: auto;
        }
        .screen.active { display: flex; }

        /* --- NAV --- */
        nav { 
            display: flex; justify-content: space-between; align-items: center; padding: 15px 30px; 
            background: rgba(5,5,8,0.8); backdrop-filter: blur(10px); border-bottom: 1px solid var(--glass-border); 
            position: sticky; top: 0; z-index: 100; 
        }
        .nav-tabs { display: flex; gap: 20px; }
        .nav-tab { cursor: pointer; color: #666; font-weight: bold; transition: 0.3s; }
        .nav-tab.active { color: var(--primary); text-shadow: 0 0 10px var(--primary); }

        /* --- FEED / CREATION CARDS (Sora Style) --- */
        #gallery { 
            display: flex; flex-direction: column; align-items: center; gap: 40px; 
            padding-bottom: 100px; width: 100%; max-width: 800px; margin: 0 auto;
        }

        .creation-card { 
            background: #000; border: 1px solid #333; border-radius: 20px; overflow: hidden; position: relative; 
            width: 100%; animation: fadeIn 0.5s ease;
        }
        
        .media-container {
            width: 100%; aspect-ratio: 16/9; background: #111; position: relative;
            display: flex; align-items: center; justify-content: center;
        }
        .creation-media { width: 100%; height: 100%; object-fit: contain; }

        /* Overlays */
        .card-overlay {
            position: absolute; bottom: 0; left: 0; width: 100%;
            background: linear-gradient(to top, rgba(0,0,0,0.9), transparent);
            padding: 20px; pointer-events: none;
        }
        .card-info { pointer-events: auto; }
        .card-prompt { font-size: 1rem; color: white; margin-bottom: 10px; text-shadow: 0 2px 4px rgba(0,0,0,0.8); }
        .card-author { font-size: 0.8rem; color: var(--primary); font-weight: bold; display: flex; align-items: center; gap: 8px; }

        /* Social Bar */
        .social-bar {
            padding: 15px; background: #0a0a0a; border-top: 1px solid #222;
            display: flex; justify-content: space-between; align-items: center;
        }
        .social-actions { display: flex; gap: 20px; }
        .social-btn { 
            background: none; border: none; color: #aaa; cursor: pointer; font-size: 1.2rem; 
            display: flex; align-items: center; gap: 6px; transition: 0.2s;
        }
        .social-btn:hover { color: white; }
        .social-btn.liked { color: #ff2a2a; }

        /* Comments Section */
        .comments-section {
            background: #050505; border-top: 1px solid #222; padding: 15px; display: none;
        }
        .comments-section.active { display: block; }
        .comment-list { max-height: 200px; overflow-y: auto; margin-bottom: 10px; font-size: 0.9rem; }
        .comment-item { margin-bottom: 8px; color: #ccc; border-bottom: 1px solid #222; padding-bottom: 5px; }
        .comment-input-row { display: flex; gap: 10px; }
        .comment-input { flex: 1; background: #222; border: 1px solid #444; color: white; padding: 8px; border-radius: 20px; outline: none; }
        
        /* --- ADMIN --- */
        #screen-admin { background: #0f0f13; padding: 30px; z-index: 2000; }
        .req-card { background: #1a1a20; padding: 20px; margin-bottom: 15px; border-radius: 12px; border: 1px solid #333; }
        .admin-tag { font-size: 0.7rem; padding: 2px 6px; border-radius: 4px; background: #333; color: #aaa; margin-left: 10px; }
        .admin-row { display: flex; gap: 10px; margin-top: 10px; }
        
        /* --- OTHERS --- */
        .controls { background: var(--glass); padding: 20px; border-radius: 20px; margin-bottom: 30px; }
        .action-btn { background: var(--primary); width: 100%; padding: 15px; border-radius: 10px; border: none; font-weight: bold; cursor: pointer; }
        #toast { position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%); background: white; color: black; padding: 12px 30px; border-radius: 30px; font-weight: bold; display: none; z-index: 9999; }
        
        /* Loaders */
        .loader { width: 30px; height: 30px; border: 4px solid #333; border-top-color: var(--primary); border-radius: 50%; animation: spin 1s infinite; }
        @keyframes spin { 100% { transform: rotate(360deg); } }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* Login */
        .login-card { background: rgba(20,20,25,0.9); padding: 40px; border-radius: 20px; text-align: center; border: 1px solid #333; }
        .auth-input { width: 100%; padding: 12px; margin-bottom: 10px; background: #111; border: 1px solid #333; color: white; border-radius: 5px; }
        .glow-btn { padding: 10px 20px; border-radius: 30px; border: 1px solid #444; background: transparent; color: white; cursor: pointer; }
    </style>
</head>
<body>

    <div class="background-fx"></div>
    <div id="offline-banner"><i class="fa-solid fa-triangle-exclamation"></i> SYSTEMS OFFLINE</div>
    <div id="queue-banner"><i class="fa-solid fa-clock"></i> HIGH TRAFFIC: QUEUE TIMES EXTENDED</div>

    <div id="screen-loading" class="screen active centered" style="background:black; z-index:5000;">
        <div class="loader"></div>
        <p style="margin-top:20px; color:#666; font-family:'Space Grotesk';">LOADING V6</p>
    </div>

    <div id="screen-login" class="screen centered" style="z-index:3000;">
        <div class="login-card">
            <h2 style="font-family:'Space Grotesk'; margin-bottom:20px;">The Ai <span style="color:var(--primary)">STudio</span></h2>
            <input type="email" id="auth-email" class="auth-input" placeholder="Email">
            <input type="password" id="auth-pass" class="auth-input" placeholder="Password">
            <button id="btn-login-email" class="glow-btn" style="background:var(--primary); color:black; width:100%; margin-bottom:10px;">Login</button>
            <button id="btn-signup-email" class="glow-btn" style="width:100%; margin-bottom:20px;">Sign Up</button>
            <button id="btn-login-google" class="glow-btn" style="border-color:#4285F4; color:#4285F4;"><i class="fa-brands fa-google"></i> Google</button>
            <p id="login-error" style="color:var(--danger); margin-top:10px; font-size:0.9rem;"></p>
        </div>
    </div>

    <div id="screen-app" class="screen">
        <nav>
            <div style="font-family:'Space Grotesk'; font-weight:bold; font-size:1.2rem;">Ai <span style="color:var(--primary)">STudio</span></div>
            <div class="nav-tabs">
                <div class="nav-tab active" id="tab-community" onclick="switchFeed('community')">COMMUNITY</div>
                <div class="nav-tab" id="tab-personal" onclick="switchFeed('personal')">MY STUDIO</div>
            </div>
            <div style="display:flex; align-items:center; gap:15px;">
                <button id="btn-open-admin" class="hidden glow-btn" onclick="toggleAdmin(true)" style="color:var(--danger); border-color:var(--danger);">ADMIN</button>
                <img id="user-pfp" style="width:35px; height:35px; border-radius:50%; border:2px solid var(--primary);">
                <i class="fa-solid fa-right-from-bracket" onclick="doLogout()" style="cursor:pointer; color:#666;"></i>
            </div>
        </nav>

        <div id="app-container" style="max-width:900px; margin:0 auto; padding:20px; width:100%;">
            
            <div id="create-controls" class="controls hidden">
                <div style="display:flex; gap:10px; margin-bottom:20px;">
                    <button class="glow-btn" id="m-banana" onclick="setModel('banana')" style="flex:1; background:rgba(255,255,255,0.1);">Nano Banana</button>
                    <button class="glow-btn" id="m-sora" onclick="setModel('sora')" style="flex:1;">Sora 2</button>
                </div>

                <div id="opt-sora" class="hidden" style="margin-bottom:15px;">
                    <span style="color:#aaa; font-size:0.8rem;">Duration:</span>
                    <button class="glow-btn" style="padding:5px 15px; font-size:0.8rem;" onclick="setDur(10)">10s</button>
                    <button class="glow-btn" style="padding:5px 15px; font-size:0.8rem; opacity:0.5;" onclick="setDur(15)">15s</button>
                </div>

                <div style="margin-bottom:15px;">
                    <label style="cursor:pointer; color:var(--primary); font-size:0.9rem;"><i class="fa-solid fa-image"></i> Upload Ref Image <input type="file" id="inp-ref-img" style="display:none;"></label>
                    <span id="ref-status" style="font-size:0.8rem; color:#666; margin-left:10px;"></span>
                </div>

                <textarea id="inp-prompt" placeholder="Describe your imagination..." style="width:100%; background:#111; border:1px solid #333; color:white; padding:15px; border-radius:10px; min-height:80px;"></textarea>
                
                <div style="display:flex; justify-content:space-between; margin-top:10px; margin-bottom:10px;">
                    <label style="color:#aaa; font-size:0.9rem;"><input type="checkbox" id="chk-public" checked> Publish to Community</label>
                    <label style="color:#aaa; font-size:0.9rem;"><input type="checkbox" id="chk-hide-prompt"> Hide Prompt</label>
                </div>

                <button id="btn-submit" class="action-btn" onclick="submitRequest()">Generate Content</button>
            </div>

            <div id="gallery"></div>
        </div>
    </div>

    <div id="screen-admin" class="screen">
        <div style="display:flex; justify-content:space-between; margin-bottom:30px; border-bottom:1px solid #333; padding-bottom:20px;">
            <h2 style="color:var(--danger); font-family:'Space Grotesk';">ADMIN TERMINAL</h2>
            <div style="display:flex; gap:10px;">
                <button id="btn-offline" onclick="toggleSystem('offline')" class="glow-btn">OFFLINE MODE</button>
                <button id="btn-queue" onclick="toggleSystem('queue')" class="glow-btn" style="color:#ffcc00; border-color:#ffcc00;">HIGH TRAFFIC</button>
                <button onclick="toggleAdmin(false)" class="glow-btn">EXIT</button>
            </div>
        </div>
        <div id="admin-list" style="max-width:1000px; margin:0 auto;"></div>
    </div>

    <div id="toast"></div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-app.js";
        import { getAuth, signInWithPopup, signInWithEmailAndPassword, createUserWithEmailAndPassword, GoogleAuthProvider, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-auth.js";
        import { getFirestore, collection, addDoc, query, where, onSnapshot, serverTimestamp, updateDoc, doc, deleteDoc, orderBy, limit, getDocs, setDoc, getDoc, arrayUnion, arrayRemove } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDQacpiI3oIqOUx8ciMfdlQgBtHZEVdcMo",
            authDomain: "anymousxe-aistudio.firebaseapp.com",
            projectId: "anymousxe-aistudio",
            storageBucket: "anymousxe-aistudio.firebasestorage.app",
            messagingSenderId: "518478280058",
            appId: "1:518478280058:web:422404fc54c21e5ea312c3"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const provider = new GoogleAuthProvider();
        const ADMIN_EMAIL = "anymousxe.info@gmail.com";

        let state = { user: null, isAdmin: false, model: 'banana', refImg: null, soraDur: 10, currentFeed: 'community' };
        let feedUnsub = null;

        // --- AUTH & INIT ---
        onAuthStateChanged(auth, (user) => {
            state.user = user;
            if (user) {
                state.isAdmin = (user.email === ADMIN_EMAIL);
                document.getElementById('user-pfp').src = user.photoURL || `https://ui-avatars.com/api/?name=${user.email.substring(0,2)}`;
                if(state.isAdmin) document.getElementById('btn-open-admin').classList.remove('hidden');
                document.getElementById('screen-app').classList.add('active');
                document.getElementById('screen-login').classList.remove('active');
                
                switchFeed('community'); // Default to community feed
                if(state.isAdmin) loadAdminQueue();
            } else {
                document.getElementById('screen-app').classList.remove('active');
                document.getElementById('screen-login').classList.add('active');
            }
            document.getElementById('screen-loading').classList.remove('active');
        });

        // --- SYSTEM STATUS ---
        onSnapshot(doc(db, "system", "status"), (snap) => {
            if(snap.exists()) {
                const d = snap.data();
                document.getElementById('offline-banner').style.display = d.offline ? 'block' : 'none';
                document.getElementById('queue-banner').style.display = d.queue ? 'block' : 'none';
                document.getElementById('btn-submit').disabled = d.offline;
                
                if(state.isAdmin) {
                    document.getElementById('btn-offline').style.background = d.offline ? 'red' : 'transparent';
                    document.getElementById('btn-queue').style.background = d.queue ? '#ffcc00' : 'transparent';
                    document.getElementById('btn-queue').style.color = d.queue ? 'black' : '#ffcc00';
                }
            }
        });

        // --- UI LOGIC ---
        window.switchFeed = (type) => {
            state.currentFeed = type;
            document.querySelectorAll('.nav-tab').forEach(e => e.classList.remove('active'));
            document.getElementById(`tab-${type}`).classList.add('active');
            
            // Show/Hide Creator Controls
            if(type === 'personal') {
                document.getElementById('create-controls').classList.remove('hidden');
                loadFeed(true);
            } else {
                document.getElementById('create-controls').classList.add('hidden');
                loadFeed(false);
            }
        };

        window.setModel = (m) => {
            state.model = m;
            document.getElementById('m-banana').style.background = m === 'banana' ? 'var(--primary)' : 'transparent';
            document.getElementById('m-banana').style.color = m === 'banana' ? 'black' : 'white';
            document.getElementById('m-sora').style.background = m === 'sora' ? '#00f2ff' : 'transparent';
            document.getElementById('m-sora').style.color = m === 'sora' ? 'black' : 'white';
            
            if(m === 'sora') document.getElementById('opt-sora').classList.remove('hidden');
            else document.getElementById('opt-sora').classList.add('hidden');
        };

        window.setDur = (d) => state.soraDur = d;

        // --- UPLOAD LOGIC (CHUNKING - KEPT INTACT) ---
        async function uploadFileAsChunks(file, onProgress) {
            const CHUNK_SIZE = 800000;
            const base64 = await new Promise(r => { 
                const reader = new FileReader(); 
                reader.onload = e => r(e.target.result); 
                reader.readAsDataURL(file); 
            });
            const total = Math.ceil(base64.length / CHUNK_SIZE);
            const gid = `group_${Date.now()}_${Math.random().toString(36).substr(2,9)}`;
            for(let i=0; i<total; i++) {
                await addDoc(collection(db, "ai_studio_files"), {
                    group: gid, index: i, total: total, data: base64.slice(i*CHUNK_SIZE, (i+1)*CHUNK_SIZE)
                });
                if(onProgress) onProgress(Math.round(((i+1)/total)*100));
            }
            return gid;
        }

        async function getChunkedFile(gid) {
            const q = query(collection(db, "ai_studio_files"), where("group", "==", gid), orderBy("index"));
            const s = await getDocs(q);
            let parts = []; s.forEach(d => parts.push(d.data().data));
            const blob = await (await fetch(parts.join(''))).blob();
            return URL.createObjectURL(blob);
        }

        document.getElementById('inp-ref-img').addEventListener('change', async (e) => {
            if(e.target.files[0]) {
                document.getElementById('ref-status').innerText = "Uploading...";
                try {
                    const gid = await uploadFileAsChunks(e.target.files[0]);
                    state.refImg = "group:" + gid;
                    document.getElementById('ref-status').innerText = "Uploaded!";
                } catch(e) { alert("Upload Failed"); }
            }
        });

        // --- REQUEST LOGIC ---
        window.submitRequest = async () => {
            const prompt = document.getElementById('inp-prompt').value;
            if(!prompt) return alert("Please enter a prompt");
            
            const btn = document.getElementById('btn-submit');
            btn.disabled = true; btn.innerText = "Sending...";
            
            try {
                await addDoc(collection(db, "ai_studio_requests"), {
                    userId: state.user.uid,
                    userName: state.user.displayName || "User",
                    userPfp: state.user.photoURL,
                    prompt: prompt,
                    model: state.model === 'sora' ? "Sora 2" : "Nano Banana",
                    status: 'pending',
                    timestamp: serverTimestamp(),
                    refImage: state.refImg,
                    duration: state.soraDur,
                    isPublic: document.getElementById('chk-public').checked,
                    hidePrompt: document.getElementById('chk-hide-prompt').checked,
                    likes: [],
                    commentsCount: 0
                });
                document.getElementById('inp-prompt').value = "";
                showToast("Request Sent!");
            } catch(e) { alert("Error: " + e.message); }
            btn.disabled = false; btn.innerText = "Generate Content";
        };

        // --- FEED LOGIC (SORA STYLE) ---
        function loadFeed(isPersonal) {
            if(feedUnsub) feedUnsub();
            const gallery = document.getElementById('gallery');
            gallery.innerHTML = '<div class="loader"></div>';

            let q;
            if(isPersonal) {
                q = query(collection(db, "ai_studio_requests"), where("userId", "==", state.user.uid), orderBy("timestamp", "desc"));
            } else {
                q = query(collection(db, "ai_studio_requests"), where("isPublic", "==", true), where("status", "==", "completed"), orderBy("timestamp", "desc"), limit(20));
            }

            feedUnsub = onSnapshot(q, (snap) => {
                gallery.innerHTML = "";
                if(snap.empty) { gallery.innerHTML = "<p style='color:#666'>Nothing here yet.</p>"; return; }
                
                snap.forEach(d => {
                    const data = d.data();
                    const id = d.id;
                    const card = document.createElement('div');
                    card.className = 'creation-card';
                    
                    // Render Content
                    let contentHtml = '';
                    if(data.status === 'pending') {
                        contentHtml = `<div class="media-container"><div class="loader"></div><div style="margin-left:15px;">Generating...</div></div>`;
                    } else if (data.status === 'error') {
                        // Custom Error / Copyright Display
                        const isCopy = data.customError === "Copyright Violation";
                        const errColor = isCopy ? "#ff8800" : "#ff2a2a";
                        const icon = isCopy ? "fa-copyright" : "fa-triangle-exclamation";
                        contentHtml = `<div class="media-container" style="border:1px solid ${errColor}; color:${errColor}; flex-direction:column;">
                            <i class="fa-solid ${icon} fa-2x"></i>
                            <div style="margin-top:10px; font-weight:bold;">${data.customError || "Generation Failed"}</div>
                        </div>`;
                    } else {
                        // Success
                        const isVid = data.model.includes('Sora');
                        // Use resultUrl. If chunked, we load async
                        contentHtml = `<div class="media-container" id="media-${id}">
                            ${isVid ? `<video class="creation-media" autoplay muted loop playsinline></video>` : `<img class="creation-media">`}
                            <div class="card-overlay">
                                <div class="card-info">
                                    <div class="card-author"><img src="${data.userPfp || 'https://ui-avatars.com/api/?name=User'}" style="width:20px; height:20px; border-radius:50%;"> ${data.userName}</div>
                                    <div class="card-prompt">${data.hidePrompt ? "<i>Prompt Hidden</i>" : data.prompt}</div>
                                </div>
                            </div>
                        </div>`;
                    }

                    // Social Bar
                    const liked = data.likes && data.likes.includes(state.user.uid);
                    const likeCount = data.likes ? data.likes.length : 0;
                    
                    const socialHtml = (data.status === 'completed') ? `
                        <div class="social-bar">
                            <div class="social-actions">
                                <button class="social-btn ${liked ? 'liked' : ''}" onclick="toggleLike('${id}')">
                                    <i class="fa-${liked ? 'solid' : 'regular'} fa-heart"></i> ${likeCount}
                                </button>
                                <button class="social-btn" onclick="toggleComments('${id}')">
                                    <i class="fa-regular fa-comment"></i> ${data.commentsCount || 0}
                                </button>
                                <button class="social-btn" onclick="navigator.clipboard.writeText('${data.prompt}')">
                                    <i class="fa-solid fa-copy"></i>
                                </button>
                            </div>
                            ${isPersonal ? `<button class="social-btn" style="color:var(--danger)" onclick="deletePost('${id}')"><i class="fa-solid fa-trash"></i></button>` : ''}
                        </div>
                        <div id="comments-${id}" class="comments-section">
                            <div id="list-${id}" class="comment-list">Loading...</div>
                            <div class="comment-input-row">
                                <input type="text" id="input-${id}" class="comment-input" placeholder="Add a comment...">
                                <button class="glow-btn" style="padding:5px 15px;" onclick="postComment('${id}')">Post</button>
                            </div>
                        </div>
                    ` : '';

                    card.innerHTML = contentHtml + socialHtml;
                    gallery.appendChild(card);

                    // Async Load Media if needed
                    if(data.status === 'completed') {
                        const container = card.querySelector(`#media-${id} .creation-media`);
                        let url = data.resultUrl;
                        if(url && url.startsWith('group:')) {
                            const gid = url.split(':')[1];
                            getChunkedFile(gid).then(u => container.src = u);
                        } else {
                            container.src = url;
                        }
                    }
                });
            });
        }

        // --- SOCIAL FUNCTIONS ---
        window.toggleLike = async (id) => {
            const ref = doc(db, "ai_studio_requests", id);
            const snap = await getDoc(ref);
            if(snap.exists()) {
                const likes = snap.data().likes || [];
                if(likes.includes(state.user.uid)) {
                    await updateDoc(ref, { likes: arrayRemove(state.user.uid) });
                } else {
                    await updateDoc(ref, { likes: arrayUnion(state.user.uid) });
                }
            }
        };

        window.toggleComments = (id) => {
            const section = document.getElementById(`comments-${id}`);
            if(section.classList.contains('active')) {
                section.classList.remove('active');
            } else {
                section.classList.add('active');
                loadComments(id);
            }
        };

        function loadComments(id) {
            const list = document.getElementById(`list-${id}`);
            const q = query(collection(db, "ai_studio_requests", id, "comments"), orderBy("time", "asc"));
            onSnapshot(q, (snap) => {
                list.innerHTML = "";
                snap.forEach(c => {
                    const cd = c.data();
                    list.innerHTML += `<div class="comment-item"><b>${cd.user}:</b> ${cd.text}</div>`;
                });
            });
        }

        window.postComment = async (id) => {
            const input = document.getElementById(`input-${id}`);
            if(!input.value) return;
            await addDoc(collection(db, "ai_studio_requests", id, "comments"), {
                user: state.user.displayName || "User",
                text: input.value,
                time: serverTimestamp()
            });
            // Update count on main doc (simple counter)
            const ref = doc(db, "ai_studio_requests", id);
            const snap = await getDoc(ref);
            await updateDoc(ref, { commentsCount: (snap.data().commentsCount || 0) + 1 });
            input.value = "";
        };

        window.deletePost = async (id) => {
            if(confirm("Delete this?")) await deleteDoc(doc(db, "ai_studio_requests", id));
        };

        // --- ADMIN FUNCTIONS ---
        function loadAdminQueue() {
            const q = query(collection(db, "ai_studio_requests"), where("status", "==", "pending"));
            onSnapshot(q, (snap) => {
                const list = document.getElementById('admin-list');
                list.innerHTML = "";
                if(snap.empty) { list.innerHTML = "<div style='text-align:center; color:#555;'>No pending requests.</div>"; return; }
                
                snap.forEach(d => {
                    const data = d.data();
                    const time = data.timestamp ? new Date(data.timestamp.seconds*1000).toLocaleTimeString() : 'Now';
                    
                    const div = document.createElement('div');
                    div.className = 'req-card';
                    div.innerHTML = `
                        <div style="display:flex; justify-content:space-between; color:#aaa; font-size:0.8rem; margin-bottom:10px;">
                            <span>${data.userName}</span>
                            <span>${time} | ${data.model} ${data.duration ? `(${data.duration}s)` : ''}</span>
                        </div>
                        <div style="background:black; padding:10px; font-family:monospace; color:#ccc; margin-bottom:10px;">${data.prompt}</div>
                        ${data.refImage ? `<div style="color:var(--primary); font-size:0.8rem; margin-bottom:10px;">+ Has Reference Image</div>` : ''}
                        
                        <input type="text" id="res-${d.id}" placeholder="Result URL..." style="width:100%; background:#111; border:1px solid #333; color:white; padding:8px; margin-bottom:5px;">
                        
                        <div class="admin-row">
                             <label class="glow-btn" style="padding:5px 10px; cursor:pointer;"><i class="fa-solid fa-upload"></i> <input type="file" style="display:none;" onchange="admUpload(this, '${d.id}')"></label>
                             <button class="glow-btn" style="background:#00ff88; color:black; flex:1;" onclick="admFinish('${d.id}', 'completed')">SEND</button>
                        </div>
                        
                        <div class="admin-row">
                            <input type="text" id="err-${d.id}" placeholder="Custom Error Reason" style="background:#330000; border:1px solid #500; color:white; padding:5px; flex:1;">
                            <button class="glow-btn" style="background:var(--danger); padding:5px 10px;" onclick="admFinish('${d.id}', 'error')">ERR</button>
                            <button class="glow-btn" style="border-color:#ff8800; color:#ff8800; padding:5px 10px;" onclick="admFinish('${d.id}', 'copyright')">COPYRIGHT</button>
                        </div>
                    `;
                    list.appendChild(div);
                });
            });
        }

        window.admUpload = async (inp, id) => {
            if(inp.files[0]) {
                const gid = await uploadFileAsChunks(inp.files[0]);
                document.getElementById(`res-${id}`).value = "group:" + gid;
            }
        };

        window.admFinish = async (id, status) => {
            let updates = { status: status };
            if(status === 'completed') {
                updates.resultUrl = document.getElementById(`res-${id}`).value;
            } else if (status === 'error') {
                updates.customError = document.getElementById(`err-${id}`).value || "Generation Failed";
            } else if (status === 'copyright') {
                updates.status = 'error';
                updates.customError = "Copyright Violation";
            }
            await updateDoc(doc(db, "ai_studio_requests", id), updates);
        };

        window.toggleSystem = async (key) => {
            const ref = doc(db, "system", "status");
            const snap = await getDoc(ref);
            let d = snap.exists() ? snap.data() : {};
            d[key] = !d[key];
            await setDoc(ref, d);
        };

        window.toggleAdmin = (s) => {
            document.getElementById('screen-admin').classList.toggle('active', s);
        };

        // --- AUTH BUTTONS ---
        document.getElementById('btn-login-google').onclick = () => signInWithPopup(auth, provider);
        document.getElementById('btn-login-email').onclick = () => signInWithEmailAndPassword(auth, document.getElementById('auth-email').value, document.getElementById('auth-pass').value).catch(e=>document.getElementById('login-error').innerText=e.message);
        document.getElementById('btn-signup-email').onclick = () => createUserWithEmailAndPassword(auth, document.getElementById('auth-email').value, document.getElementById('auth-pass').value).catch(e=>document.getElementById('login-error').innerText=e.message);
        window.doLogout = () => signOut(auth);

        function showToast(msg) {
            const t = document.getElementById('toast');
            t.innerText = msg; t.style.display = 'block';
            setTimeout(()=>t.style.display='none', 3000);
        }
    </script>
</body>
</html>
