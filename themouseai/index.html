<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Solstice | AI Studio</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --bg-dark: #09090b;
            --bg-card: #18181b;
            --accent: #6366f1; /* Indigo */
            --text-primary: #f4f4f5;
            --text-secondary: #a1a1aa;
        }

        body { 
            background-color: var(--bg-dark); 
            color: var(--text-primary); 
            font-family: 'Inter', sans-serif; 
            -webkit-font-smoothing: antialiased;
        }

        /* Glassmorphism */
        .glass {
            background: rgba(24, 24, 27, 0.6);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.08);
        }

        .glass-heavy {
            background: rgba(9, 9, 11, 0.85);
            backdrop-filter: blur(20px);
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
        }

        /* Chat Bubbles */
        .msg-user {
            background: linear-gradient(135deg, #4f46e5 0%, #3730a3 100%);
            color: white;
            border-radius: 20px 20px 4px 20px;
            box-shadow: 0 4px 15px rgba(79, 70, 229, 0.3);
        }
        
        .msg-bot {
            background: var(--bg-card);
            border: 1px solid rgba(255,255,255,0.05);
            color: var(--text-primary);
            border-radius: 20px 20px 20px 4px;
        }

        /* Animations */
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .fade-in { animation: fadeIn 0.4s cubic-bezier(0.16, 1, 0.3, 1) forwards; }

        /* Scrollbar */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #3f3f46; border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: #52525b; }

        /* Loader */
        .typing-dot { animation: typing 1.4s infinite ease-in-out both; background-color: #a1a1aa; }
        .typing-dot:nth-child(1) { animation-delay: -0.32s; }
        .typing-dot:nth-child(2) { animation-delay: -0.16s; }
        @keyframes typing { 0%, 80%, 100% { transform: scale(0); opacity: 0.5; } 40% { transform: scale(1); opacity: 1; } }

        /* Canvas Panel */
        #canvas-panel { transition: transform 0.4s cubic-bezier(0.16, 1, 0.3, 1); transform: translateX(100%); right: 0; top: 0; bottom: 0; }
        #canvas-panel.open { transform: translateX(0); }
    </style>
</head>
<body class="h-screen flex overflow-hidden selection:bg-indigo-500 selection:text-white">

    <div id="auth-overlay" class="fixed inset-0 z-[60] flex flex-col items-center justify-center bg-black/90 backdrop-blur-xl transition-opacity duration-500">
        <div class="relative group">
            <div class="absolute -inset-1 bg-gradient-to-r from-indigo-500 to-purple-600 rounded-2xl blur opacity-25 group-hover:opacity-50 transition duration-1000 group-hover:duration-200"></div>
            <div class="relative p-10 bg-[#18181b] ring-1 ring-white/10 rounded-2xl text-center max-w-sm w-full">
                <h1 class="text-4xl font-bold mb-2 text-transparent bg-clip-text bg-gradient-to-br from-white to-gray-400 tracking-tight">Solstice</h1>
                <p class="text-gray-500 mb-8 text-sm">Next Generation AI Interface</p>
                <button id="login-btn" class="w-full py-3.5 bg-white text-black rounded-xl font-semibold hover:bg-gray-200 transition-all flex items-center justify-center gap-3 shadow-lg shadow-white/5">
                    <i class="fab fa-google text-lg"></i> Continue with Google
                </button>
            </div>
        </div>
    </div>

    <div class="w-[280px] bg-[#0c0c0e] border-r border-white/5 flex flex-col hidden md:flex shrink-0 z-20">
        <div class="p-5 flex justify-between items-center">
            <div class="flex items-center gap-2">
                <div class="w-2 h-2 rounded-full bg-indigo-500 shadow-[0_0_10px_rgba(99,102,241,0.5)]"></div>
                <span class="font-semibold text-lg tracking-tight">Solstice</span>
            </div>
            <button id="new-chat-btn" class="w-8 h-8 flex items-center justify-center rounded-lg hover:bg-white/5 text-gray-400 hover:text-white transition">
                <i class="fas fa-pen-to-square"></i>
            </button>
        </div>
        
        <div class="px-3 pb-2 text-xs font-medium text-gray-500 uppercase tracking-wider">History</div>
        <div id="chat-list" class="flex-1 overflow-y-auto px-3 space-y-1">
            </div>

        <div class="p-4 border-t border-white/5 mt-auto">
            <button id="admin-btn" class="hidden w-full mb-3 py-2 px-3 text-sm bg-red-500/10 text-red-400 border border-red-500/20 rounded-lg hover:bg-red-500/20 transition flex items-center gap-2">
                <i class="fas fa-lock"></i> Admin Config
            </button>
            
            <div id="user-profile" class="flex items-center gap-3 p-2 rounded-xl hover:bg-white/5 cursor-pointer transition">
                <div class="w-8 h-8 rounded-full bg-gray-700 animate-pulse"></div>
                <div class="text-sm font-medium text-gray-300">Loading...</div>
            </div>
        </div>
    </div>

    <div class="flex-1 flex flex-col relative h-full bg-[#09090b]">
        <header class="h-16 glass-heavy absolute top-0 w-full z-10 flex items-center justify-between px-6">
            <div class="flex items-center gap-3">
                <span class="text-gray-400 text-sm">Model</span>
                <div class="flex items-center gap-1.5 px-3 py-1 bg-indigo-500/10 border border-indigo-500/20 rounded-full">
                    <i class="fas fa-star text-[10px] text-indigo-400"></i>
                    <span class="text-xs font-semibold text-indigo-300">Solstice 1</span>
                </div>
            </div>
            <button id="toggle-canvas" class="px-4 py-1.5 text-sm text-gray-300 bg-white/5 border border-white/10 rounded-lg hover:bg-white/10 transition flex items-center gap-2">
                <i class="fas fa-code"></i> Canvas
            </button>
        </header>

        <div id="chat-container" class="flex-1 overflow-y-auto pt-20 pb-32 px-4 md:px-32 scroll-smooth">
            <div class="h-full flex flex-col items-center justify-center text-center opacity-50 select-none">
                <div class="w-16 h-16 rounded-2xl bg-gradient-to-tr from-indigo-500 to-purple-600 mb-6 flex items-center justify-center shadow-2xl">
                    <i class="fas fa-sparkles text-2xl text-white"></i>
                </div>
                <h2 class="text-2xl font-semibold text-white mb-2">Solstice 1</h2>
                <p class="text-gray-500 max-w-md">The most advanced assistant. Capable of coding, casual conversation, and creative writing.</p>
            </div>
        </div>

        <div class="absolute bottom-0 w-full bg-gradient-to-t from-[#09090b] via-[#09090b] to-transparent pb-6 px-4 md:px-20 pt-10 z-20">
            <div class="max-w-4xl mx-auto relative group">
                <div class="absolute -inset-0.5 bg-gradient-to-r from-indigo-500/30 to-purple-500/30 rounded-2xl blur opacity-0 group-hover:opacity-100 transition duration-500"></div>
                
                <div class="relative glass rounded-2xl p-2 flex items-end gap-2 bg-[#18181b]">
                    <div class="relative">
                        <button id="tools-btn" class="p-3 text-gray-400 hover:text-white hover:bg-white/10 rounded-xl transition h-[48px] w-[48px]">
                            <i class="fas fa-plus"></i>
                        </button>
                        <div id="tool-menu" class="hidden absolute bottom-full left-0 mb-3 w-48 bg-[#1f1f23] border border-white/10 rounded-xl shadow-2xl overflow-hidden py-1 z-20">
                            <button class="w-full text-left px-4 py-2.5 hover:bg-white/5 text-sm text-gray-300 hover:text-white flex items-center gap-3 transition" onclick="alert('Image Generation selected (Placeholder)');">
                                <i class="fas fa-image text-purple-400"></i> Generate Image
                            </button>
                            <button class="w-full text-left px-4 py-2.5 hover:bg-white/5 text-sm text-gray-300 hover:text-white flex items-center gap-3 transition" id="mem-btn">
                                <i class="fas fa-brain text-green-400"></i> Add to Memory
                            </button>
                        </div>
                    </div>

                    <textarea id="user-input" rows="1" class="flex-1 bg-transparent border-0 focus:ring-0 text-white resize-none py-3 px-2 max-h-48 placeholder-gray-500 leading-relaxed" placeholder="Message Solstice..."></textarea>
                    
                    <button id="send-btn" class="p-3 bg-white text-black rounded-xl hover:bg-gray-200 transition disabled:opacity-50 disabled:cursor-not-allowed h-[48px] w-[48px] flex items-center justify-center">
                        <i class="fas fa-arrow-up"></i>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div id="canvas-panel" class="fixed top-0 right-0 w-[600px] h-full bg-[#131316] border-l border-white/10 shadow-2xl z-[50] flex flex-col translate-x-full">
        <div class="h-16 border-b border-white/5 flex justify-between items-center px-6 bg-[#18181b]">
            <span class="font-medium text-gray-200"><i class="fas fa-terminal text-indigo-500 mr-2"></i> Canvas</span>
            <button id="close-canvas" class="text-gray-500 hover:text-white transition"><i class="fas fa-times"></i></button>
        </div>
        <div class="flex-1 overflow-auto p-0">
            <pre id="canvas-content" class="p-6 text-sm font-mono text-gray-300 leading-loose">No code generated yet.</pre>
        </div>
    </div>

    <div id="admin-modal" class="hidden fixed inset-0 z-[70] flex items-center justify-center bg-black/80 backdrop-blur-sm">
        <div class="bg-[#18181b] border border-red-500/30 p-8 rounded-2xl w-[500px] shadow-2xl shadow-red-900/20">
            <h2 class="text-2xl font-bold mb-1 text-white">Admin Configuration</h2>
            <p class="text-gray-500 text-sm mb-6">Global API Keys (Affects all users)</p>
            
            <div class="space-y-4">
                <div>
                    <label class="block text-xs text-gray-400 mb-2 uppercase font-semibold tracking-wider">OpenRouter API Key</label>
                    <input type="password" id="admin-key" class="w-full bg-black/50 border border-white/10 rounded-xl p-3 text-sm text-white focus:border-indigo-500 outline-none transition" placeholder="sk-or-...">
                </div>
            </div>
            
            <div class="flex justify-end gap-3 mt-8">
                <button id="close-admin" class="px-5 py-2.5 rounded-xl text-gray-400 hover:text-white hover:bg-white/5 transition">Cancel</button>
                <button id="save-admin" class="px-5 py-2.5 bg-indigo-600 rounded-xl hover:bg-indigo-500 text-white font-medium transition shadow-lg shadow-indigo-500/20">Save Global Key</button>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-app.js";
        import { getAuth, signInWithPopup, GoogleAuthProvider, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-auth.js";
        import { getFirestore, collection, addDoc, query, where, orderBy, onSnapshot, doc, updateDoc, deleteDoc, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-firestore.js";

        // --- Config ---
        const firebaseConfig = {
            apiKey: "AIzaSyC8dbdkl9XrQqNwWQX8dZHz9jagkHtIQng",
            authDomain: "themouseai.firebaseapp.com",
            projectId: "themouseai",
            storageBucket: "themouseai.firebasestorage.app",
            messagingSenderId: "797579380344",
            appId: "1:797579380344:web:7dfa79ad7ac551d53ecf8d",
            measurementId: "G-ZC6SXZE2TR"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const ADMIN_EMAIL = "anymousxe.info@gmail.com";
        const MODEL_ID = "mistralai/mistral-nemo"; 

        // --- State ---
        let currentUser = null;
        let currentChatId = null;
        let globalApiKey = null; 

        // --- Auth ---
        const loginBtn = document.getElementById('login-btn');
        const authOverlay = document.getElementById('auth-overlay');
        const userProfile = document.getElementById('user-profile');
        const adminBtn = document.getElementById('admin-btn');

        loginBtn.addEventListener('click', () => signInWithPopup(auth, new GoogleAuthProvider()));

        onAuthStateChanged(auth, async (user) => {
            if (user) {
                currentUser = user;
                authOverlay.classList.add('opacity-0', 'pointer-events-none');
                
                userProfile.innerHTML = `
                    <img src="${user.photoURL}" class="w-8 h-8 rounded-full border border-white/10"> 
                    <div class="flex flex-col">
                        <span class="text-sm font-medium text-white leading-tight">${user.displayName}</span>
                        <span class="text-[10px] text-gray-500">Online</span>
                    </div>`;

                if (user.email === ADMIN_EMAIL) {
                    adminBtn.classList.remove('hidden');
                }

                loadChats();
                fetchGlobalKey();
            } else {
                authOverlay.classList.remove('opacity-0', 'pointer-events-none');
            }
        });

        // --- Key Management ---
        async function fetchGlobalKey() {
            try {
                const docSnap = await getDoc(doc(db, "config", "global"));
                if (docSnap.exists()) {
                    globalApiKey = docSnap.data().key;
                } else {
                    console.warn("No Global Key Found in Database");
                }
            } catch(e) { console.log("Key fetch error:", e); }
        }

        const adminModal = document.getElementById('admin-modal');
        const adminKeyInput = document.getElementById('admin-key');
        
        adminBtn.addEventListener('click', async () => {
            adminModal.classList.remove('hidden');
            if(globalApiKey) adminKeyInput.value = globalApiKey;
        });

        document.getElementById('close-admin').addEventListener('click', () => adminModal.classList.add('hidden'));
        
        document.getElementById('save-admin').addEventListener('click', async () => {
            const newKey = adminKeyInput.value.trim();
            if(!newKey) return;
            await setDoc(doc(db, "config", "global"), { key: newKey }, { merge: true });
            globalApiKey = newKey;
            adminModal.classList.add('hidden');
            alert("Global Key Updated.");
        });

        // --- Chat Logic ---
        const chatList = document.getElementById('chat-list');
        document.getElementById('new-chat-btn').addEventListener('click', createChat);

        async function createChat() {
            if (!currentUser) return;
            const docRef = await addDoc(collection(db, "chats"), {
                userId: currentUser.uid,
                title: "New Conversation",
                createdAt: new Date(),
                messages: []
            });
            selectChat(docRef.id);
        }

        function loadChats() {
            const q = query(collection(db, "chats"), where("userId", "==", currentUser.uid), orderBy("createdAt", "desc"));
            onSnapshot(q, (snap) => {
                chatList.innerHTML = '';
                snap.forEach(d => {
                    const data = d.data();
                    const isActive = d.id === currentChatId;
                    const div = document.createElement('div');
                    div.className = `p-3 rounded-xl cursor-pointer transition-all duration-200 flex justify-between group ${isActive ? 'bg-indigo-600 text-white shadow-lg shadow-indigo-500/20' : 'text-gray-400 hover:bg-white/5 hover:text-gray-200'}`;
                    div.innerHTML = `
                        <span class="truncate text-sm font-medium">${data.title}</span>
                        <i class="fas fa-trash text-xs opacity-0 group-hover:opacity-100 hover:text-red-300 transition" onclick="deleteChat('${d.id}', event)"></i>
                    `;
                    div.onclick = (e) => { if(!e.target.classList.contains('fa-trash')) selectChat(d.id); };
                    chatList.appendChild(div);
                });
            });
        }

        window.deleteChat = async (id, e) => {
            e.stopPropagation();
            if(confirm("Delete chat?")) await deleteDoc(doc(db, "chats", id));
            if(currentChatId === id) window.location.reload();
        };

        async function selectChat(id) {
            currentChatId = id;
            const d = await getDoc(doc(db, "chats", id));
            const container = document.getElementById('chat-container');
            container.innerHTML = '<div class="h-20"></div>'; 
            const msgs = d.data().messages || [];
            msgs.forEach(m => renderMessage(m.role, m.content));
            container.scrollTop = container.scrollHeight;
        }

        // --- Messaging ---
        const userInput = document.getElementById('user-input');
        const sendBtn = document.getElementById('send-btn');

        userInput.addEventListener('input', function() {
            this.style.height = 'auto';
            this.style.height = (this.scrollHeight) + 'px';
            if(this.value === '') this.style.height = 'auto';
        });

        userInput.addEventListener('keydown', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                handleSend();
            }
        });

        sendBtn.addEventListener('click', handleSend);

        async function handleSend() {
            const text = userInput.value.trim();
            if (!text || !currentChatId) return;

            userInput.value = '';
            userInput.style.height = 'auto';
            
            renderMessage('user', text);

            const chatRef = doc(db, "chats", currentChatId);
            const chatSnap = await getDoc(chatRef);
            let msgs = chatSnap.data().messages || [];
            msgs.push({ role: 'user', content: text });
            
            // Optimistic update
            await updateDoc(chatRef, { messages: msgs });

            // Bot Response
            const loader = showLoader();
            try {
                if(!globalApiKey) {
                    // Try to fetch one last time in case it just updated
                    await fetchGlobalKey();
                    if(!globalApiKey) throw new Error("System Offline. Admin must configure API Key.");
                }
                
                const response = await callOpenRouter(msgs);
                loader.remove();
                
                renderMessage('assistant', response);
                msgs.push({ role: 'assistant', content: response });
                
                await updateDoc(chatRef, { 
                    messages: msgs,
                    title: msgs.length <= 2 ? text.substring(0, 30) : chatSnap.data().title
                });

                // Canvas Auto-Open
                if(response.includes('```')) {
                    const codeMatch = response.match(/```([\s\S]*?)```/);
                    if(codeMatch && codeMatch[1]) {
                        document.getElementById('canvas-content').innerText = codeMatch[1];
                        document.getElementById('canvas-panel').classList.add('open');
                    }
                }

            } catch (err) {
                loader.remove();
                renderMessage('assistant', `⚠️ ${err.message}`);
                console.error(err);
            }
        }

        function renderMessage(role, content) {
            const container = document.getElementById('chat-container');
            const div = document.createElement('div');
            div.className = `flex w-full mb-6 fade-in ${role === 'user' ? 'justify-end' : 'justify-start'}`;
            
            let formatted = content
                .replace(/\*\*(.*?)\*\*/g, '<b>$1</b>')
                .replace(/```([\s\S]*?)```/g, '<div class="bg-black/30 p-2 rounded my-2 text-xs font-mono overflow-x-auto border border-white/10 text-indigo-300">Code (View in Canvas)</div>');

            div.innerHTML = `
                <div class="${role === 'user' ? 'msg-user' : 'msg-bot'} max-w-[85%] md:max-w-[70%] px-5 py-4 text-sm md:text-base leading-7 shadow-sm">
                    ${formatted}
                </div>
            `;
            container.appendChild(div);
            container.scrollTop = container.scrollHeight;
        }

        function showLoader() {
            const container = document.getElementById('chat-container');
            const div = document.createElement('div');
            div.className = 'flex w-full mb-6 justify-start fade-in';
            div.innerHTML = `
                <div class="msg-bot px-4 py-3 flex items-center gap-1">
                    <div class="w-1.5 h-1.5 rounded-full typing-dot"></div>
                    <div class="w-1.5 h-1.5 rounded-full typing-dot"></div>
                    <div class="w-1.5 h-1.5 rounded-full typing-dot"></div>
                </div>`;
            container.appendChild(div);
            container.scrollTop = container.scrollHeight;
            return div;
        }

        // --- API & Prompt Engineering ---
        async function callOpenRouter(messages) {
            let memory = "No saved memory.";
            try {
               const mSnap = await getDoc(doc(db, "user_memory", currentUser.uid));
               if(mSnap.exists()) memory = mSnap.data().content;
            } catch(e) {}

            const systemPrompt = {
                role: "system",
                content: `IDENTITY: You are Solstice 1, a highly advanced AI created by Anymousxe. 
                STRICT RULES:
                1. NEVER mention you are Mistral, OpenAI, or any other model. You are Solstice 1.
                2. Tone: Gen-Z slang, chill, 'bet', 'valid', 'bruh'. NO 'bestie', 'slay', or 'queen'.
                3. If asked about image gen, say you support it (simulate the description) but don't output an API error.
                4. MEMORY CONTEXT: ${memory}`
            };

            const response = await fetch("[https://openrouter.ai/api/v1/chat/completions](https://openrouter.ai/api/v1/chat/completions)", {
                method: "POST",
                headers: {
                    "Authorization": `Bearer ${globalApiKey}`,
                    "Content-Type": "application/json",
                    "HTTP-Referer": window.location.href, // Required by OpenRouter
                    "X-Title": "Solstice Studio"
                },
                body: JSON.stringify({
                    model: MODEL_ID,
                    messages: [systemPrompt, ...messages]
                })
            });

            if (!response.ok) {
                // If API fails, get the text error to debug
                const errText = await response.text();
                throw new Error(`API Error ${response.status}: ${errText.substring(0, 100)}...`);
            }

            // Safe JSON parse
            const text = await response.text();
            try {
                const json = JSON.parse(text);
                return json.choices[0].message.content;
            } catch (e) {
                throw new Error("Invalid JSON received from API.");
            }
        }

        // --- Tools & Canvas Toggles ---
        const toolsBtn = document.getElementById('tools-btn');
        const toolMenu = document.getElementById('tool-menu');
        const memBtn = document.getElementById('mem-btn');

        toolsBtn.addEventListener('click', () => toolMenu.classList.toggle('hidden'));
        
        memBtn.addEventListener('click', async () => {
            toolMenu.classList.add('hidden');
            const txt = prompt("What should Solstice remember about you?");
            if(txt) {
                const ref = doc(db, "user_memory", currentUser.uid);
                const snap = await getDoc(ref);
                const old = snap.exists() ? snap.data().content : "";
                await setDoc(ref, { content: old + "\n- " + txt });
                alert("Memory Updated.");
            }
        });

        // Manual Canvas Toggle
        document.getElementById('close-canvas').addEventListener('click', () => {
            document.getElementById('canvas-panel').classList.remove('open');
        });
        document.getElementById('toggle-canvas').addEventListener('click', () => {
            document.getElementById('canvas-panel').classList.add('open');
        });

    </script>
</body>
</html>
